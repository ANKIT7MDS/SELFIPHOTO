<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Upload - EventLens</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

  <style>
    /* BRANDING VARS (Will be updated by JS) */
    :root {
      --bg: #050505; --card: #111; --text: #fff;
      --accent: #00e676; --accent-soft: rgba(0, 230, 118, 0.15);
      --logo-size: 80px; --banner-height: 200px; --overlay-op: 0.5;
    }

    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
    
    /* HEADER (Same as Index) */
    header { 
        position: relative; height: var(--banner-height); overflow: hidden; 
        background-color: #222; background-size: cover; background-position: center;
        transition: height 0.3s ease; border-bottom: 1px solid #333;
    }
    .header-overlay {
        position: absolute; inset: 0; 
        background: linear-gradient(to bottom, rgba(0,0,0,var(--overlay-op)), var(--bg));
        display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; text-align: center; align-items: center;
    }
    .brand-logo {
        width: var(--logo-size); height: var(--logo-size);
        border-radius: 50%; border: 3px solid var(--accent);
        object-fit: cover; margin-bottom: 10px; background: #000;
        display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    .brand-title { font-size: 24px; font-weight: 800; margin: 0; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
    .welcome-text { font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 5px; display: none; }

    /* UPLOAD CONTAINER */
    .container { width: 100%; max-width: 600px; margin: -40px auto 40px; padding: 0 20px; position: relative; z-index: 2; }
    .card { background: var(--card); border: 1px solid #333; border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
    
    select { width: 100%; padding: 14px; background: #222; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 20px; font-size: 16px; outline: none; }
    select:focus { border-color: var(--accent); }
    
    .upload-box { border: 2px dashed #444; padding: 40px; border-radius: 12px; cursor: pointer; transition: 0.3s; }
    .upload-box:hover { border-color: var(--accent); background: var(--accent-soft); }
    .upload-box i { font-size: 40px; color: #555; margin-bottom: 10px; transition: 0.3s; }
    .upload-box:hover i { color: var(--accent); }
    
    .btn { background: var(--accent); color: #000; border: none; padding: 14px; width: 100%; font-weight: 700; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 20px; transition: 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 15px var(--accent-soft); }
    
    /* PROGRESS UI */
    .progress-section { margin-top: 25px; text-align: left; display: none; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; }
    .progress-bar-bg { height: 10px; background: #000; border-radius: 5px; overflow: hidden; margin-bottom: 10px; border: 1px solid #333; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; box-shadow: 0 0 10px var(--accent); }
    .status-row { display: flex; justify-content: space-between; font-size: 13px; color: #ccc; margin-bottom: 5px; }
    .log-text { font-size: 11px; color: #666; margin-top: 5px; font-family: monospace; }
    
    .hidden { display: none !important; }
    
    /* Footer */
    footer { margin-top: auto; text-align: center; padding: 20px; color: #555; font-size: 12px; border-top: 1px solid #222; }
  </style>
</head>
<body>

<!-- BRANDING HEADER -->
<header id="pageHeader">
    <div class="header-overlay">
        <img id="pageLogo" class="brand-logo" onerror="this.style.display='none'">
        <div id="welcomeText" class="welcome-text">Staff Upload Portal</div>
        <h1 class="brand-title" id="pageTitle">EventLens Upload</h1>
    </div>
</header>

<div class="container">
  <div class="card">
    <div style="margin-bottom: 20px;">
        <i class="fa-solid fa-cloud-arrow-up" style="font-size: 32px; color: var(--accent); margin-bottom: 10px;"></i>
        <h3 style="margin: 0;">Bulk Upload</h3>
        <p style="color:#666; font-size:13px; margin-top:5px;">Optimize for High Volume (2000+)</p>
    </div>

    <!-- Collection Dropdown (Hidden if cid in URL) -->
    <div id="colSelectWrap" class="hidden">
        <label style="display:block; text-align:left; margin-bottom:5px; color:#888; font-size:12px;">COLLECTION</label>
        <select id="colSelect" onchange="loadEvents()"></select>
    </div>

    <label style="display:block; text-align:left; margin-bottom:5px; color:#888; font-size:12px;">TARGET EVENT</label>
    <select id="eventSelect">
      <option value="">Loading events...</option>
    </select>

    <div class="upload-box" onclick="document.getElementById('fileInput').click()" ondragover="event.preventDefault(); this.style.borderColor=var(--accent);" ondragleave="this.style.borderColor='#444';" ondrop="handleDrop(event)">
      <i class="fa-solid fa-images"></i>
      <p style="margin:0; font-weight:600;">Click or Drop Photos</p>
      <p style="margin:5px 0 0; font-size:12px; color:#666;">JPG, JPEG, HEIC supported</p>
      <input type="file" id="fileInput" multiple accept="image/*" hidden onchange="handleFiles(this.files)">
    </div>

    <div id="fileCount" style="margin-top: 15px; font-weight: 600; color: var(--accent); display:none;">0 Files Selected</div>

    <button class="btn" id="uploadBtn" onclick="startUpload()" disabled>Start Upload</button>

    <!-- PROGRESS UI -->
    <div class="progress-section" id="progressSection">
        <div class="status-row">
            <span id="mainStatus">Initializing...</span>
            <span id="pctText">0%</span>
        </div>
        <div class="progress-bar-bg">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="status-row">
            <span id="detailStatus">Waiting to start...</span>
            <span><i class="fa-solid fa-server"></i> Auto-Indexing</span>
        </div>
        <div class="log-text" id="logText">Ready.</div>
    </div>
  </div>
</div>

<footer>Powered by EventLens Technology</footer>

<script>
    const API_BASE = "https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod";
    
    // Auth Logic
    const urlParams = new URLSearchParams(window.location.search);
    let token = urlParams.get('token') || localStorage.getItem('idToken');
    
    const preCid = urlParams.get('cid');
    const preEid = urlParams.get('eid');
    let queue = [];

    // --- INIT ---
    window.onload = async () => {
        if(!token) {
             token = localStorage.getItem('idToken'); 
             if(!token) alert("Warning: No Auth Token found. Uploads might fail if not logged in.");
        }

        // Load Branding & Data
        if(preCid) {
            loadBranding(preCid);
            await loadEvents(preCid);
        } else {
            document.getElementById('colSelectWrap').classList.remove('hidden');
            await loadCollections();
        }
    };

    // --- BRANDING (Robust Fetch) ---
    async function loadBranding(cid) {
        try {
            const res = await fetch(`${API_BASE}/get-branding?cid=${cid}`);
            if(res.ok) applyBranding(await res.json());
        } catch(e) { console.error("Branding error", e); }
    }

    function applyBranding(data) {
        if(data.collection_name) {
            document.getElementById('pageTitle').innerText = data.collection_name;
            document.title = `${data.collection_name} â€“ Upload`;
        }
        if(data.color) {
            document.documentElement.style.setProperty('--accent', data.color);
            document.documentElement.style.setProperty('--accent-soft', data.color + '26');
            document.getElementById('pageLogo').style.borderColor = data.color;
        }
        // Safe Image Loading
        if(data.header_img) {
            const img = new Image();
            img.onload = () => document.getElementById('pageHeader').style.backgroundImage = `url('${data.header_img}')`;
            img.src = data.header_img;
        }
        if(data.logo) {
            const logo = document.getElementById('pageLogo');
            logo.src = data.logo;
            logo.style.display = 'block';
        }
        if(data.welcome_msg) {
            const el = document.getElementById('welcomeText');
            el.innerText = data.welcome_msg;
            el.style.display = 'block';
        }
        
        // Dynamic CSS Injection for sizes
        const style = document.createElement('style');
        style.innerHTML = `
            :root { --logo-size: ${data.logo_size_mob || '80'}px; --banner-height: ${data.banner_h_mob || '200'}px; }
            @media (min-width: 768px) { :root { --logo-size: ${data.logo_size_desk || '120'}px; --banner-height: ${data.banner_h_desk || '350'}px; } }
        `;
        document.head.appendChild(style);
    }

    // --- DATA LOADING ---
    async function loadCollections() {
        try {
            const res = await fetch(`${API_BASE}/get-collections`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            const sel = document.getElementById('colSelect');
            sel.innerHTML = '<option value="">Select Collection...</option>' + 
                (data.Items || []).map(c => `<option value="${c.collection_id}">${c.name}</option>`).join('');
        } catch(e) { console.error(e); }
    }

    async function loadEvents(cidOverride) {
        const cid = cidOverride || document.getElementById('colSelect').value;
        if(!cid) return;
        
        if(!cidOverride) loadBranding(cid);

        try {
            const res = await fetch(`${API_BASE}/get-events`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ collection_id: cid })
            });
            const data = await res.json();
            const sel = document.getElementById('eventSelect');
            sel.innerHTML = '<option value="">Select Event...</option>' + 
                (data.events || []).map(e => `<option value="${e.event_id}">${e.name}</option>`).join('');
                
            if(preEid) sel.value = preEid;
        } catch(e) { console.error(e); }
    }

    // --- FILE HANDLING ---
    function handleDrop(e) {
        e.preventDefault();
        handleFiles(e.dataTransfer.files);
    }

    function handleFiles(files) {
        const newFiles = Array.from(files);
        queue = [...queue, ...newFiles];
        
        const countEl = document.getElementById('fileCount');
        countEl.style.display = 'block';
        countEl.innerText = `${queue.length} Files Ready`;
        
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('uploadBtn').innerText = `Upload ${queue.length} Photos`;
    }

    // --- BULK UPLOAD ENGINE ---
    async function startUpload() {
        const cid = preCid || document.getElementById('colSelect').value;
        const eid = document.getElementById('eventSelect').value;
        if(!cid) return alert("Select a Collection!");
        if(!eid) return alert("Select an Event!");

        document.getElementById('uploadBtn').disabled = true;
        document.getElementById('progressSection').style.display = 'block';
        
        // BATCH CONFIG
        const BATCH_SIZE = 50; // AWS Gateway Limit safe zone
        let totalProcessed = 0;
        const totalFiles = queue.length;
        let successCount = 0;
        let failCount = 0;
        
        for (let i = 0; i < totalFiles; i += BATCH_SIZE) {
            const chunk = queue.slice(i, i + BATCH_SIZE);
            const batchNum = Math.ceil((i + 1) / BATCH_SIZE);
            const totalBatches = Math.ceil(totalFiles / BATCH_SIZE);
            
            updateStatus(
                `Uploading Batch ${batchNum}/${totalBatches}`, 
                `Processing ${chunk.length} photos...`, 
                (totalProcessed / totalFiles) * 100
            );

            try {
                // 1. Prepare Metadata (Hash + HEIC conversion + Rename)
                const metas = await Promise.all(chunk.map(async f => {
                    let procFile = f;
                    
                    // HEIC Conversion Logic
                    if(f.name.toLowerCase().endsWith('.heic')){
                        updateLog(`Converting HEIC: ${f.name}`);
                        try {
                            const blob = await heic2any({ blob: f, toType: "image/jpeg", quality: 0.8 });
                            procFile = new File([blob], f.name.replace(/\.heic$/i, ".jpg"), { type: "image/jpeg" });
                        } catch(e) { 
                            console.warn("HEIC convert failed", e); 
                            return null; // Skip bad file
                        }
                    }
                    
                    // Normalize Filename (VERY IMPORTANT FOR AWS)
                    // Replaces spaces/special chars with underscores, forces lowercase extension
                    let cleanName = procFile.name.replace(/[^a-zA-Z0-9.]/g, '_');
                    // Force .jpg extension logic
                    const parts = cleanName.split('.');
                    if(parts.length > 1) parts.pop();
                    cleanName = parts.join('.') + ".jpg";

                    // Calculate Hash (for Backend verification)
                    const b = await procFile.arrayBuffer();
                    const h = await crypto.subtle.digest('SHA-256', b);
                    const hash = Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
                    
                    return { name: cleanName, type: 'image/jpeg', size: procFile.size, hash: hash, file: procFile };
                }));

                // Filter out failed conversions
                const validMetas = metas.filter(m => m !== null);

                // 2. Get Presigned URLs
                if(validMetas.length > 0) {
                    const res = await fetch(`${API_BASE}/generate-upload-urls`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ collection_id: cid, event_id: eid, files: validMetas })
                    });
                    const data = await res.json();

                    // 3. Upload to S3 (Parallel)
                    if(data.urls && data.urls.length > 0) {
                        await Promise.all(data.urls.map(async (u) => {
                            const item = validMetas.find(m => m.hash === u.hash);
                            if(!item) return;
                            
                            try {
                                await fetch(u.uploadURL, {
                                    method: 'PUT',
                                    body: item.file,
                                    headers: { 
                                        'Content-Type': 'image/jpeg',
                                        'x-amz-meta-original-hash': u.hash
                                    }
                                });
                                successCount++;
                            } catch(err) {
                                console.error("Upload Put Failed", err);
                                failCount++;
                            }
                        }));
                    }
                }
                
                totalProcessed += chunk.length;
                updateStatus(
                    `Batch ${batchNum} Done`, 
                    `Sent for Indexing. Success: ${successCount} | Failed: ${failCount}`, 
                    (totalProcessed / totalFiles) * 100
                );

            } catch (e) {
                console.error("Batch Failed", e);
                updateLog(`Batch Error: ${e.message}`);
                failCount += chunk.length;
            }
        }

        // Completion
        updateStatus("Complete!", "All photos uploaded. Indexing is running on server.", 100);
        document.getElementById('progressFill').style.backgroundColor = '#00e676';
        alert(`Upload Finished!\n\nSuccessfully Uploaded: ${successCount}\nFailed: ${failCount}\n\nPhotos will appear in the gallery shortly as they get indexed.`);
        
        // Reset UI
        queue = []; 
        document.getElementById('fileCount').innerText = "0 Files";
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('uploadBtn').innerText = "Start Upload";
    }

    function updateStatus(main, detail, pct) {
        document.getElementById('mainStatus').innerText = main;
        document.getElementById('detailStatus').innerText = detail;
        document.getElementById('pctText').innerText = Math.round(pct) + "%";
        document.getElementById('progressFill').style.width = pct + "%";
    }
    
    function updateLog(msg) {
        const el = document.getElementById('logText');
        el.innerText = msg;
    }
</script>
</body>
</html>
