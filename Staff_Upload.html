<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Upload - EventLens</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

  <style>
    /* BRANDING VARS */
    :root {
      --bg: #050505; --card: #111; --text: #fff;
      --accent: #00e676; --accent-soft: rgba(0, 230, 118, 0.15);
      --logo-size: 80px; --banner-height: 200px; --overlay-op: 0.5;
    }

    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
    
    /* PIN SCREEN */
    #pinScreen {
        position: fixed; inset: 0; background: #000; z-index: 100;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
    }
    .pin-card {
        background: #111; border: 1px solid #333; padding: 40px; border-radius: 20px;
        text-align: center; width: 100%; max-width: 400px;
    }
    .pin-input {
        width: 100%; padding: 15px; background: #000; border: 1px solid #333;
        color: #fff; font-size: 24px; text-align: center; letter-spacing: 5px;
        border-radius: 10px; margin: 20px 0; outline: none;
    }
    .pin-input:focus { border-color: var(--accent); }

    /* HEADER */
    header { 
        position: relative; height: var(--banner-height); overflow: hidden; 
        background-color: #222; background-size: cover; background-position: center;
        border-bottom: 1px solid #333;
    }
    .header-overlay {
        position: absolute; inset: 0; 
        background: linear-gradient(to bottom, rgba(0,0,0,var(--overlay-op)), var(--bg));
        display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; text-align: center; align-items: center;
    }
    .brand-logo {
        width: var(--logo-size); height: var(--logo-size);
        border-radius: 50%; border: 3px solid var(--accent);
        object-fit: cover; margin-bottom: 10px; background: #000;
        display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    .brand-title { font-size: 24px; font-weight: 800; margin: 0; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
    .welcome-text { font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 5px; display: none; }

    /* UPLOAD CONTAINER */
    .container { width: 100%; max-width: 600px; margin: -40px auto 40px; padding: 0 20px; position: relative; z-index: 2; display: none; }
    .card { background: var(--card); border: 1px solid #333; border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
    
    select { width: 100%; padding: 14px; background: #222; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 20px; font-size: 16px; outline: none; }
    select:focus { border-color: var(--accent); }
    
    .upload-box { border: 2px dashed #444; padding: 40px; border-radius: 12px; cursor: pointer; transition: 0.3s; }
    .upload-box:hover { border-color: var(--accent); background: var(--accent-soft); }
    .upload-box i { font-size: 40px; color: #555; margin-bottom: 10px; transition: 0.3s; }
    .upload-box:hover i { color: var(--accent); }
    
    .btn { background: var(--accent); color: #000; border: none; padding: 14px; width: 100%; font-weight: 700; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 20px; transition: 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 15px var(--accent-soft); }
    
    /* PROGRESS UI */
    .progress-section { margin-top: 25px; text-align: left; display: none; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; }
    .progress-bar-bg { height: 10px; background: #000; border-radius: 5px; overflow: hidden; margin-bottom: 10px; border: 1px solid #333; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; box-shadow: 0 0 10px var(--accent); }
    .status-row { display: flex; justify-content: space-between; font-size: 13px; color: #ccc; margin-bottom: 5px; }
    .log-text { font-size: 11px; color: #666; margin-top: 5px; font-family: monospace; }
    
    .hidden { display: none !important; }
    footer { margin-top: auto; text-align: center; padding: 20px; color: #555; font-size: 12px; border-top: 1px solid #222; }
  </style>
</head>
<body>

<!-- 1. PIN SECURITY SCREEN -->
<div id="pinScreen">
    <div class="pin-card">
        <i class="fa-solid fa-lock" style="font-size: 40px; color: var(--accent); margin-bottom: 20px;"></i>
        <h2>Staff Access</h2>
        <p style="color:#888; font-size:14px;">Enter PIN to access upload portal</p>
        <input type="tel" id="entryPin" class="pin-input" maxlength="6" placeholder="••••">
        <button class="btn" onclick="verifyPin()">Enter</button>
        <div id="pinError" style="color:#ff4444; margin-top:15px; font-size:13px;"></div>
    </div>
</div>

<!-- 2. MAIN APP -->
<header id="pageHeader">
    <div class="header-overlay">
        <img id="pageLogo" class="brand-logo" onerror="this.style.display='none'">
        <div id="welcomeText" class="welcome-text">Staff Upload Portal</div>
        <h1 class="brand-title" id="pageTitle">EventLens Upload</h1>
    </div>
</header>

<div class="container" id="mainApp">
  <div class="card">
    <div style="margin-bottom: 20px;">
        <i class="fa-solid fa-cloud-arrow-up" style="font-size: 32px; color: var(--accent); margin-bottom: 10px;"></i>
        <h3 style="margin: 0;">Bulk Upload</h3>
        <p style="color:#666; font-size:13px; margin-top:5px;">Optimized for High Volume</p>
    </div>

    <!-- Collection info is mostly hidden as it comes from URL -->
    <div id="colSelectWrap" class="hidden">
        <label style="display:block; text-align:left; margin-bottom:5px; color:#888; font-size:12px;">COLLECTION</label>
        <select id="colSelect" onchange="loadEvents()"></select>
    </div>

    <label style="display:block; text-align:left; margin-bottom:5px; color:#888; font-size:12px;">TARGET EVENT</label>
    <select id="eventSelect">
      <option value="">Loading events...</option>
    </select>

    <div class="upload-box" onclick="document.getElementById('fileInput').click()" ondragover="event.preventDefault(); this.style.borderColor=var(--accent);" ondragleave="this.style.borderColor='#444';" ondrop="handleDrop(event)">
      <i class="fa-solid fa-images"></i>
      <p style="margin:0; font-weight:600;">Click or Drop Photos</p>
      <p style="margin:5px 0 0; font-size:12px; color:#666;">JPG, JPEG, HEIC supported</p>
      <input type="file" id="fileInput" multiple accept="image/*" hidden onchange="handleFiles(this.files)">
    </div>

    <div id="fileCount" style="margin-top: 15px; font-weight: 600; color: var(--accent); display:none;">0 Files Selected</div>

    <button class="btn" id="uploadBtn" onclick="startUpload()" disabled>Start Upload</button>

    <!-- PROGRESS UI -->
    <div class="progress-section" id="progressSection">
        <div class="status-row">
            <span id="mainStatus">Initializing...</span>
            <span id="pctText">0%</span>
        </div>
        <div class="progress-bar-bg">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="status-row">
            <span id="detailStatus">Waiting to start...</span>
            <span><i class="fa-solid fa-server"></i> Auto-Indexing</span>
        </div>
        <div class="log-text" id="logText">Ready.</div>
    </div>
  </div>
</div>

<footer>Powered by EventLens Technology</footer>

<script>
    const API_BASE = "https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod";
    
    // Params
    const urlParams = new URLSearchParams(window.location.search);
    const cid = urlParams.get('cid');
    const eid = urlParams.get('eid');
    const urlPin = urlParams.get('pin');
    
    let queue = [];
    window.cachedEvents = null; // To store events from branding if available

    // --- 1. PIN VERIFICATION ---
    window.onload = () => {
        // Auto-fill pin if in URL
        if(urlPin) document.getElementById('entryPin').value = urlPin;
        
        // If no CID, show error immediately
        if(!cid) {
            document.getElementById('pinError').innerText = "Error: Invalid Link (Missing Collection ID)";
            return;
        }
    };

    function verifyPin() {
        const inputPin = document.getElementById('entryPin').value;
        const err = document.getElementById('pinError');
        
        if(urlPin && inputPin !== urlPin) {
            err.innerText = "Incorrect PIN";
            return;
        }
        
        if(!inputPin) {
            err.innerText = "Please enter PIN";
            return;
        }

        // Unlock UI
        document.getElementById('pinScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        
        // Load Data
        loadBranding(cid);
        loadEvents(cid);
    }

    // --- 2. DATA LOADING (NO AUTH TOKEN) ---
    async function loadBranding(collectionId) {
        try {
            // Fetch branding via public endpoint or fallback
            const res = await fetch(`${API_BASE}/get-branding?cid=${collectionId}`);
            if(res.ok) {
                const data = await res.json();
                
                // 1. Try to cache events if they exist in the branding response
                // (Sometimes get-branding returns full collection object)
                if (data.events && Array.isArray(data.events)) {
                    window.cachedEvents = data.events;
                }
                
                applyBranding(data);
            }
        } catch(e) { console.warn("Branding load failed", e); }
    }

    function applyBranding(data) {
        if(data.collection_name) {
            document.getElementById('pageTitle').innerText = data.collection_name;
            document.title = `${data.collection_name} – Upload`;
        }
        if(data.color) {
            document.documentElement.style.setProperty('--accent', data.color);
            document.documentElement.style.setProperty('--accent-soft', data.color + '26');
            document.getElementById('pageLogo').style.borderColor = data.color;
        }
        if(data.header_img) {
            document.getElementById('pageHeader').style.backgroundImage = `url('${data.header_img}')`;
        }
        if(data.logo) {
            const logo = document.getElementById('pageLogo');
            logo.src = data.logo;
            logo.style.display = 'block';
        }
        if(data.welcome_msg) {
            const el = document.getElementById('welcomeText');
            el.innerText = data.welcome_msg;
            el.style.display = 'block';
        }
    }

    // UPDATED: Now uses client-api with 'get_events' action to bypass auth
    // Also checks cache from branding first
    async function loadEvents(cidOverride) {
        const sel = document.getElementById('eventSelect');
        const collectionId = cidOverride || document.getElementById('colSelect').value;
        
        if(!collectionId) return;

        // Helper function to populate dropdown
        const populateDropdown = (events) => {
            if(events.length > 0) {
                sel.innerHTML = '<option value="">Select Event...</option>' + 
                    events.map(e => {
                        // Try various keys for event name
                        const name = e.name || e.event_name || e.title || e.Name || e.event_id || 'Unnamed Event';
                        return `<option value="${e.event_id}">${name}</option>`;
                    }).join('');
            } else {
                sel.innerHTML = `<option value="default">General Upload (No Events)</option>`;
            }
            if(eid) sel.value = eid;
        };

        // A. Check if we already got events from branding call
        if (window.cachedEvents) {
            console.log("Using cached events from branding");
            populateDropdown(window.cachedEvents);
            return;
        }

        // B. Fetch from API
        try {
            const res = await fetch(`${API_BASE}/client-api`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: "get_events", 
                    payload: { collection_id: collectionId } 
                })
            });
            
            if(res.ok) {
                let data = await res.json();
                if(data.body && typeof data.body === 'string') {
                    try { data = JSON.parse(data.body); } catch(e){}
                }

                const events = data.events || [];
                populateDropdown(events);

            } else {
                throw new Error("Fetch failed");
            }
        } catch(e) { 
            console.warn("Event list fetch failed", e);
            // Fallback
            sel.innerHTML = `<option value="default">General Upload (Fallback)</option>`;
            if(eid) sel.innerHTML += `<option value="${eid}" selected>Current Event</option>`;
        }
    }

    // --- 3. FILE HANDLING ---
    function handleDrop(e) {
        e.preventDefault();
        handleFiles(e.dataTransfer.files);
    }

    function handleFiles(files) {
        const newFiles = Array.from(files);
        queue = [...queue, ...newFiles];
        
        const countEl = document.getElementById('fileCount');
        countEl.style.display = 'block';
        countEl.innerText = `${queue.length} Files Ready`;
        
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('uploadBtn').innerText = `Upload ${queue.length} Photos`;
    }

    // --- 4. UPLOAD ENGINE ---
    async function startUpload() {
        let targetEid = document.getElementById('eventSelect').value;
        if(!targetEid) return alert("Please select an event or general upload!");
        
        // Handle fallback "default" value - send as null to backend
        if(targetEid === 'default') targetEid = null;

        document.getElementById('uploadBtn').disabled = true;
        document.getElementById('progressSection').style.display = 'block';
        
        const BATCH_SIZE = 50;
        let totalProcessed = 0;
        const totalFiles = queue.length;
        let successCount = 0;
        let failCount = 0;
        
        for (let i = 0; i < totalFiles; i += BATCH_SIZE) {
            const chunk = queue.slice(i, i + BATCH_SIZE);
            const batchNum = Math.ceil((i + 1) / BATCH_SIZE);
            const totalBatches = Math.ceil(totalFiles / BATCH_SIZE);
            
            updateStatus(
                `Uploading Batch ${batchNum}/${totalBatches}`, 
                `Processing ${chunk.length} photos...`, 
                (totalProcessed / totalFiles) * 100
            );

            try {
                // A. Prepare Meta
                const metas = await Promise.all(chunk.map(async f => {
                    let procFile = f;
                    // HEIC Conversion
                    if(f.name.toLowerCase().endsWith('.heic')){
                        updateLog(`Converting: ${f.name}`);
                        try {
                            const blob = await heic2any({ blob: f, toType: "image/jpeg", quality: 0.8 });
                            procFile = new File([blob], f.name.replace(/\.heic$/i, ".jpg"), { type: "image/jpeg" });
                        } catch(e) { return null; }
                    }
                    
                    // Clean Name & Hash
                    let cleanName = procFile.name.replace(/[^a-zA-Z0-9.]/g, '_');
                    const parts = cleanName.split('.');
                    if(parts.length > 1) parts.pop();
                    cleanName = parts.join('.') + ".jpg";

                    const b = await procFile.arrayBuffer();
                    const h = await crypto.subtle.digest('SHA-256', b);
                    const hash = Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
                    
                    return { name: cleanName, type: 'image/jpeg', size: procFile.size, hash: hash, file: procFile };
                }));

                const validMetas = metas.filter(m => m !== null);

                // B. Get Presigned URLs (FIXED: Uses /client-api with action logic)
                if(validMetas.length > 0) {
                    const res = await fetch(`${API_BASE}/client-api`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        // Sending CID allows backend to verify validity without user token
                        body: JSON.stringify({ 
                            action: "generate_upload_urls",
                            payload: {
                                collection_id: cid, 
                                event_id: targetEid || eid, 
                                files: validMetas 
                            }
                        })
                    });
                    
                    if(!res.ok) throw new Error("Server rejected upload request");
                    
                    let data = await res.json();
                    if(data.body && typeof data.body === 'string') {
                        try { data = JSON.parse(data.body); } catch(e){}
                    }

                    // C. Upload to S3
                    if(data.urls) {
                        await Promise.all(data.urls.map(async (u) => {
                            const item = validMetas.find(m => m.hash === u.hash);
                            if(!item) return;
                            try {
                                await fetch(u.uploadURL, {
                                    method: 'PUT',
                                    body: item.file,
                                    headers: { 'Content-Type': 'image/jpeg', 'x-amz-meta-original-hash': u.hash }
                                });
                                successCount++;
                            } catch(err) { failCount++; }
                        }));
                    }
                }
                
                totalProcessed += chunk.length;
                updateStatus(`Batch ${batchNum} Done`, `Success: ${successCount} | Failed: ${failCount}`, (totalProcessed / totalFiles) * 100);

            } catch (e) {
                console.error("Batch Failed", e);
                updateLog(`Error: ${e.message}`);
                failCount += chunk.length;
            }
        }

        // Finish
        updateStatus("Complete!", "Indexing photos...", 100);
        document.getElementById('progressFill').style.backgroundColor = '#00e676';
        alert(`Upload Finished!\nSuccess: ${successCount}\nFailed: ${failCount}`);
        
        queue = []; 
        document.getElementById('fileCount').innerText = "0 Files";
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('uploadBtn').innerText = "Start Upload";
    }

    function updateStatus(main, detail, pct) {
        document.getElementById('mainStatus').innerText = main;
        document.getElementById('detailStatus').innerText = detail;
        document.getElementById('pctText').innerText = Math.round(pct) + "%";
        document.getElementById('progressFill').style.width = pct + "%";
    }
    
    function updateLog(msg) {
        document.getElementById('logText').innerText = msg;
    }
</script>
</body>
</html>
