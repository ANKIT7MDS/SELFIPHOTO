<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>EventLens Pro – Admin Console</title>
  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root { --bg-dark: #050505; --bg-panel: #111111; --primary: #00e676; --primary-dim: rgba(0, 230, 118, 0.15); --text-main: #ffffff; --text-muted: #a1a1aa; --border-color: #27272a; --radius-md: 12px; }
    * { box-sizing: border-box; outline: none; }
    body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: "Plus Jakarta Sans", sans-serif; font-size: 14px; min-height: 100vh; overflow-x: hidden; }
    
    /* UTILS & COMPONENTS */
    .wrap { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .logo { font-family: 'Outfit', sans-serif; font-size: 22px; font-weight: 800; color: #fff; display: flex; align-items: center; gap: 10px; }
    .logo span { color: var(--primary); }
    .btn { border: none; padding: 10px 20px; border-radius: 50px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 13px; }
    .btn.primary { background: var(--primary); color: #000; }
    .btn.secondary { background: #27272a; color: #fff; border: 1px solid var(--border-color); }
    .btn.danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
    .card { background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 24px; margin-bottom: 24px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input, select, textarea { background: #000; border: 1px solid var(--border-color); color: #fff; padding: 12px; border-radius: 8px; width: 100%; font-family: inherit; font-size: 14px; transition: 0.2s; }
    
    /* COLLECTIONS LIST */
    .col-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
    .col-card {
        background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;
        transition: 0.2s; position: relative; cursor: pointer;
    }
    .col-card:hover { border-color: var(--primary); transform: translateY(-3px); background: rgba(255,255,255,0.05); }
    .col-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 8px; }
    .col-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 12px; margin-bottom: 20px; }
    .col-actions { display: flex; gap: 10px; margin-top: auto; }
    .col-actions .btn { flex: 1; justify-content: center; }

    /* TABLES */
    .styled-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    .styled-table th { text-align: left; padding: 12px 16px; color: var(--text-muted); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
    .styled-table td { background: rgba(255,255,255,0.03); padding: 16px; vertical-align: middle; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
    .styled-table tr td:first-child { border-left: 1px solid var(--border-color); border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
    .styled-table tr td:last-child { border-right: 1px solid var(--border-color); border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
    .styled-table tr:hover td { background: rgba(255,255,255,0.06); }
    
    /* CLIENT ACTIVITY */
    .sel-summary { display: flex; gap: 20px; margin-bottom: 20px; }
    .sel-box { flex: 1; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; text-align: center; }
    .sel-val { font-size: 24px; font-weight: 700; color: #fff; }
    .sel-label { font-size: 11px; color: #888; text-transform: uppercase; }
    
    /* LEAD HISTORY (MERGED GUESTS) */
    .lead-row { cursor: pointer; }
    .lead-history { display: none; }
    .lead-history.open { display: table-row; animation: fadeIn 0.3s; }
    .hist-item { display: flex; align-items: center; gap: 10px; background: #222; padding: 8px; border-radius: 8px; border: 1px solid #333; margin-bottom: 5px; }

    /* PREVIEW CONTAINER */
    .preview-frame { border: 4px solid #333; border-radius: 16px; overflow: hidden; background: #000; margin: 0 auto; transition: all 0.3s ease; position: relative; }
    .preview-frame.mobile { width: 320px; height: 600px; border-width: 8px 4px; }
    .preview-frame.desktop { width: 100%; height: 500px; border-width: 4px; }
    .prev-header { position: relative; background-size: cover; background-position: center; transition: height 0.3s; display: flex; align-items: flex-end; justify-content: center; background-color: #222; }
    .prev-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.8)); display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding: 15px; }
    .prev-logo { border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; margin-bottom: 8px; background: #000; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: all 0.3s; }
    .prev-title { font-size: 18px; font-weight: 800; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
    .prev-welcome { font-size: 10px; text-align: center; color: rgba(255,255,255,0.8); margin-top: 4px; }

    .tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; overflow-x: auto; padding-bottom: 8px; }
    .tab { padding: 10px 24px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; font-weight: 600; border-radius: 20px; white-space: nowrap; transition: 0.2s; }
    .tab.active { color: #000; background: var(--primary); }
    .tab-content { display: none; } .tab-content.active { display: block; }
    .view { display: none; } .view.show { display: block; } .hidden { display: none !important; }
    
    /* GALLERY & UPLOAD */
    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; margin-top: 16px; content-visibility: auto; contain-intrinsic-size: 140px; }
    .ph-card { aspect-ratio: 1; background: #1a1a1a; border-radius: 8px; overflow: hidden; position: relative; cursor: pointer; transform: translateZ(0); }
    .ph-card img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; background-color: #222; }
    .ph-card img.loaded { opacity: 1; }
    .ph-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); opacity: 0; transition: 0.2s; display: flex; flex-direction: column; justify-content: flex-end; padding: 10px; }
    .ph-card:hover .ph-overlay { opacity: 1; }

    /* UTILS */
    .kpi-box { background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%); padding: 24px; border-radius: 16px; border: 1px solid var(--border-color); position: relative; overflow: hidden; }
    .kpi-box::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); opacity: 0.5; }
    .kpi-val { font-size: 32px; font-weight: 800; color: #fff; margin-top: 8px; font-family: 'Outfit', sans-serif; }
    .settings-group { border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; background: rgba(255,255,255,0.02); margin-bottom: 20px; }
    .settings-title { font-weight: 700; color: var(--primary); margin-bottom: 15px; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }

    /* LIGHTBOX */
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
    .lightbox.open { display: flex; opacity: 1; }
    .lb-img { max-width: 90vw; max-height: 80vh; border-radius: 4px; }
    .lb-close { position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: #fff; font-size: 32px; cursor: pointer; }
    .lb-controls { position: absolute; bottom: 20px; display: flex; gap: 20px; }

    #toast { position: fixed; top: 24px; right: 24px; background: #1a1a1a; color: #fff; padding: 16px 24px; border-radius: 12px; z-index: 9999; transform: translateX(150%); transition: 0.4s; border: 1px solid var(--border-color); }
    #toast.show { transform: translateX(0); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div id="toast"></div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox">
  <button class="lb-close" onclick="closeLightbox()">&times;</button>
  <img src="" id="lbImage" class="lb-img">
  <div class="lb-controls">
      <button class="btn secondary" onclick="downloadCurrentPhoto()">Download</button>
      <button class="btn danger" onclick="deleteCurrentPhoto()">Delete</button>
  </div>
</div>

<div class="wrap" id="mainWrap">
  <div class="topbar">
    <div class="logo"><i class="fa-solid fa-camera-retro"></i> EventLens <span>Pro</span></div>
    <div class="row">
      <div id="userBadge" class="text-sm" style="background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 20px;">Guest</div>
      <button class="btn primary" id="btnLogin" onclick="doLogin()">Login</button>
      <button class="btn danger hidden" id="btnLogout" onclick="doLogout()">Logout</button>
    </div>
  </div>

  <div id="vLogin" class="view">
    <div class="card" style="max-width: 480px; margin: 80px auto; text-align: center; padding: 40px;">
      <h2>Welcome Back</h2>
      <button class="btn primary" onclick="doLogin()">Login via AWS Cognito</button>
    </div>
  </div>

  <div id="vDash" class="view">
    <div class="row" style="margin-bottom: 24px;">
      <h2 style="margin: 0;">Dashboard Overview</h2>
    </div>

    <!-- STATS -->
    <div class="grid" style="margin-bottom: 32px;">
       <div class="kpi-box"><div class="text-sm" style="font-weight: 700; color: var(--text-muted);">COLLECTIONS</div><div class="kpi-val" id="dCols">0</div></div>
       <div class="kpi-box"><div class="text-sm" style="font-weight: 700; color: var(--text-muted);">TOTAL PHOTOS</div><div class="kpi-val" id="dPhotos">Loading...</div></div>
       <div class="kpi-box"><div class="text-sm" style="font-weight: 700; color: var(--text-muted);">STORAGE USED</div><div class="kpi-val" id="dStorage">Loading...</div></div>
       <div class="kpi-box"><div class="text-sm" style="font-weight: 700; color: var(--text-muted);">STATUS</div><div class="kpi-val" id="dStatus" style="font-size: 20px; color: var(--primary);">Active</div></div>
    </div>

    <div class="card">
        <div class="row" style="justify-content: space-between; margin-bottom: 24px;">
            <h3>My Collections</h3>
            <button class="btn primary" onclick="toggleNewCol(true)"><i class="fa-solid fa-plus"></i> New Collection</button>
        </div>
        <div id="newColBox" class="card hidden">
            <input id="ncName" placeholder="e.g. Rahul Wedding"> <button class="btn primary" onclick="createCollection()">Create</button>
        </div>
        
        <!-- MODERN CARD LAYOUT -->
        <div id="colList" class="col-list"></div>
    </div>
  </div>

  <div id="vCol" class="view">
    <div class="row" style="margin-bottom: 24px; justify-content: space-between;">
      <button class="btn secondary" onclick="route('dashboard')"><i class="fa-solid fa-arrow-left"></i> Back</button>
      <h2 id="cdTitle">-</h2>
    </div>
    <div class="text-sm text-muted" id="cdId" style="margin-bottom: 20px;">ID: -</div>

    <div class="tabs">
      <button class="tab active" onclick="setTab('tGal')">Gallery</button>
      <button class="tab" onclick="setTab('tEvents')">Events</button>
      <button class="tab" onclick="setTab('tUp')">Upload</button>
      <button class="tab" onclick="setTab('tLink')">Links</button>
      <button class="tab" onclick="setTab('tClient')">Client Selections</button>
      <button class="tab" onclick="setTab('tLeads')">Guest Leads</button>
      <button class="tab" onclick="setTab('tSettings')">Branding & Settings</button>
    </div>

    <!-- TAB 1: GALLERY -->
    <div id="tGal" class="tab-content active">
      <div class="card">
        <div class="row" style="margin-bottom: 20px; justify-content: space-between;">
           <div class="row">
             <select id="galEventFilter" style="width: 200px;"></select>
             <div class="text-sm text-muted" id="galCount">0 Photos</div>
           </div>
           <button class="btn secondary" onclick="loadPhotos(true)"><i class="fa-solid fa-rotate-right"></i> Refresh</button>
        </div>
        <div class="gallery-grid" id="galGrid"></div>
        <div style="text-align:center; margin-top: 30px;">
          <button class="btn secondary hidden" id="btnLoadMore" onclick="loadPhotos(false, true)">Load More Photos</button>
        </div>
      </div>
    </div>

    <!-- TAB 2: EVENTS -->
    <div id="tEvents" class="tab-content">
      <div class="card">
        <div class="row" style="justify-content: space-between; margin-bottom: 20px; align-items: flex-start;">
            <div>
                <h3>Manage Sub-Events</h3>
                <p class="text-sm text-muted">Organize photos into sub-events (Haldi, Reception, etc).</p>
            </div>
            
            <div id="evAddForm" style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; gap: 8px;">
              <input id="neName" placeholder="Event Name" style="border:none; background:transparent; border-bottom:1px solid #444; border-radius:0; padding:5px; width:150px;">
              <input id="neDate" type="date" style="border:none; background:transparent; border-bottom:1px solid #444; border-radius:0; padding:5px;">
              <button class="btn primary" onclick="createNewEvent()" style="padding: 6px 16px; font-size:12px;">Add</button>
            </div>
        </div>

        <div id="evEditForm" class="hidden" style="background: rgba(0, 230, 118, 0.05); padding: 16px; border-radius: 12px; margin: 10px 0 20px; border: 1px solid var(--primary-dim);">
           <div class="row" style="margin-bottom: 8px;">
             <span class="text-sm font-bold" style="color:var(--primary)">EDIT EVENT</span>
           </div>
           <input id="eeId" type="hidden">
           <div class="row">
              <input id="eeName" placeholder="New Event Name" style="flex:2">
              <input id="eeDate" type="date" style="flex:1">
              <button class="btn primary" onclick="updateEvent()">Save Changes</button>
              <button class="btn secondary" onclick="cancelEditEvent()">Cancel</button>
           </div>
        </div>

        <div class="table-responsive">
            <table class="styled-table">
              <thead><tr><th>Event Name</th><th>Date</th><th>Photos</th><th>Size</th><th>Actions</th></tr></thead>
              <tbody id="tblEvents"></tbody>
            </table>
        </div>
      </div>
    </div>

    <!-- TAB 3: UPLOAD -->
    <div id="tUp" class="tab-content">
      <div class="card">
        <div class="row" style="justify-content: space-between; align-items: flex-start;">
            <div>
                <h3>Batch Photo Upload</h3>
                <p class="text-sm text-muted">Photos queue up first. Click 'Start Upload' to process.</p>
            </div>
            <button class="btn secondary" onclick="copyStaffLink()">
                <i class="fa-solid fa-user-plus"></i> Get Staff Upload Link
            </button>
        </div>
        
        <div class="row" style="margin: 24px 0;">
          <div style="flex: 1; max-width: 400px;">
            <label class="text-sm" style="display:block; margin-bottom: 6px;">Select Target Event</label>
            <select id="upEventSel"></select>
          </div>
        </div>

        <div style="border: 2px dashed var(--border-color); padding: 40px; text-align: center; border-radius: 16px; position: relative; transition: 0.2s;" ondragover="this.style.borderColor=var(--primary)" ondragleave="this.style.borderColor='var(--border-color)'">
          <i class="fa-solid fa-cloud-arrow-up" style="font-size: 32px; color: var(--text-muted); margin-bottom: 12px;"></i>
          <h4 style="margin: 0; color: #fff;">Click to Select Photos</h4>
          <p class="text-sm text-muted">Queue up multiple files (JPG, HEIC)</p>
          <input type="file" id="upInput" multiple accept="image/*" style="position:absolute; inset:0; opacity:0; cursor:pointer" onchange="queueFiles(this.files)">
        </div>

        <div id="uploadQueueBox" class="hidden" style="margin-top: 20px;">
           <div class="row" style="justify-content:space-between; margin-bottom: 10px;">
              <h4>Upload Queue (<span id="queueCount">0</span>)</h4>
              <button class="btn primary" id="btnStartUpload" onclick="startUploadProcess()">Start Upload</button>
           </div>
           <div id="queueList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;"></div>
        </div>

        <div id="upProgress" class="hidden" style="margin-top: 20px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
          <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
            <span class="text-sm font-bold" id="upStatusText">Uploading...</span>
            <span class="text-sm" id="upPct">0%</span>
          </div>
          <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
            <div id="upBar" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.3s ease;"></div>
          </div>
          <div class="text-sm text-muted" style="margin-top: 10px;" id="upCountStr">Processing...</div>
        </div>
      </div>
    </div>

    <!-- TAB 4: LINK GENERATION -->
    <div id="tLink" class="tab-content">
      <div class="card">
        <h3>Generate Guest Link</h3>
        <div class="row" style="gap: 20px; align-items: flex-end; margin-top: 24px;">
          <div style="flex: 2;">
            <label class="text-sm" style="display:block; margin-bottom:6px;">Select Event Scope</label>
            <select id="linkEventSel"></select>
          </div>
          <div style="flex: 1;">
            <label class="text-sm" style="display:block; margin-bottom:6px;">Link Expiry</label>
            <select id="linkExpiry">
              <option value="87600">Lifetime</option>
              <option value="168">7 Days</option>
              <option value="24">24 Hours</option>
            </select>
          </div>
          <div style="flex: 1;">
            <label class="text-sm" style="display:block; margin-bottom:6px;">PIN Protection</label>
            <input id="linkPin" placeholder="e.g. 1234">
          </div>
          <button class="btn primary" onclick="generateLink()" style="height: 46px;">Generate Link</button>
        </div>

        <div id="linkRes" class="hidden" style="margin-top: 24px; background: rgba(0, 230, 118, 0.05); padding: 20px; border-radius: 12px; border: 1px solid var(--primary-dim);">
           <div class="text-sm" style="color: var(--primary); font-weight: 700; margin-bottom: 8px;">SHAREABLE GUEST LINK</div>
           <div class="row">
             <input id="finalLink" readonly style="background: transparent; border: none; color: #fff; font-size: 16px; font-family: monospace; padding: 0;">
             <button class="btn secondary" onclick="copyLink()">Copy Link</button>
             <a id="finalLinkBtn" target="_blank" class="btn primary">Open Page</a>
           </div>
        </div>
        
        <hr style="border:0; border-top:1px solid #333; margin:30px 0;">
        
        <h3>Generate Client Selection Link</h3>
        <div class="row" style="gap: 20px; align-items: flex-end;">
          <div style="flex: 2;">
            <label class="text-sm" style="display:block; margin-bottom:6px;">Client Gallery PIN</label>
            <input id="clientPin" placeholder="e.g. 9876">
          </div>
          <button class="btn primary" onclick="generateClientLink()" style="height: 46px;">Create Client Link</button>
        </div>
         <div id="clientLinkRes" class="hidden" style="margin-top: 24px; background: rgba(0, 230, 118, 0.05); padding: 20px; border-radius: 12px; border: 1px solid var(--primary-dim);">
           <div class="text-sm" style="color: var(--primary); font-weight: 700; margin-bottom: 8px;">CLIENT SELECTION LINK</div>
           <div class="row">
             <input id="clientFinalLink" readonly style="background: transparent; border: none; color: #fff; font-size: 16px; font-family: monospace; padding: 0;">
             <button class="btn secondary" onclick="copyClientLink()">Copy Link</button>
             <a id="clientLinkBtn" target="_blank" class="btn primary">Open Gallery</a>
           </div>
        </div>
      </div>
    </div>
    
    <!-- NEW TAB: CLIENT SELECTIONS -->
    <div id="tClient" class="tab-content">
        <div class="card">
            <div class="row" style="justify-content:space-between; margin-bottom:20px;">
                <h3>Client Activity</h3>
                <button class="btn secondary" onclick="loadClientSelections()"><i class="fa-solid fa-rotate-right"></i> Refresh</button>
            </div>
            
            <div class="sel-summary">
                <div class="sel-box"><div class="sel-val" id="sumSel">0</div><div class="sel-label">Selected</div></div>
                <div class="sel-box"><div class="sel-val" id="sumFav">0</div><div class="sel-label">Favorites</div></div>
                <div class="sel-box" style="border-color:var(--primary-dim);"><div class="sel-val" style="color:var(--primary)" id="sumDel">0</div><div class="sel-label">Delete Req</div></div>
            </div>
            
            <div class="table-responsive">
               <table class="styled-table">
                   <thead><tr><th>Photo ID</th><th>Status</th><th>Actions</th></tr></thead>
                   <tbody id="tblSelections"><tr><td colspan="3" align="center" class="text-muted">No client activity yet.</td></tr></tbody>
               </table>
            </div>
        </div>
    </div>

    <!-- TAB 5: GUEST LEADS (MERGED) -->
    <div id="tLeads" class="tab-content">
      <div class="card">
        <div class="row" style="justify-content: space-between; margin-bottom: 20px;">
          <h3>Guest Leads & Analytics</h3>
          <button class="btn secondary" onclick="loadLeads()"><i class="fa-solid fa-rotate-right"></i> Refresh Data</button>
        </div>
        <div class="table-responsive">
          <table class="styled-table">
            <thead><tr><th>Guest Name</th><th>Phone Number</th><th>Activity</th><th>Actions</th></tr></thead>
            <tbody id="tblLeads"><tr><td colspan="4" align="center" class="text-muted">Loading leads...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB 6: SETTINGS (UPDATED WITH LIVE PREVIEW) -->
    <div id="tSettings" class="tab-content">
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;">
            
            <!-- LEFT: CONTROLS -->
            <div class="card">
                <h3>Customization Controls</h3>
                <p class="text-sm text-muted">Adjust settings and see changes live.</p>
                
                <div class="settings-group">
                    <div class="settings-title"><i class="fa-solid fa-image"></i> Visual Assets</div>
                    <label class="text-sm">Header Image (Banner)</label>
                    <div class="row" style="margin-bottom: 12px;">
                       <input id="setHeadImg" placeholder="Image URL" oninput="manualUpdate('setHeadImg')">
                       <input type="file" id="fileHeadImg" hidden onchange="uploadAsset(this, 'setHeadImg')">
                       <button class="btn secondary" onclick="$('#fileHeadImg').click()">Upload</button>
                    </div>
                    <label class="text-sm">Logo</label>
                    <div class="row">
                       <input id="setLogo" placeholder="Logo URL" oninput="manualUpdate('setLogo')">
                       <input type="file" id="fileLogo" hidden onchange="uploadAsset(this, 'setLogo')">
                       <button class="btn secondary" onclick="$('#fileLogo').click()">Upload</button>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-title"><i class="fa-solid fa-pen-nib"></i> Text & Content</div>
                    <label class="text-sm">Collection Title</label>
                    <input id="setColName" style="margin-bottom: 12px;" oninput="updatePreview()">
                    <label class="text-sm">Welcome Message</label>
                    <textarea id="setWelcome" rows="3" oninput="updatePreview()" style="margin-bottom: 12px;"></textarea>
                    <label class="text-sm">Footer Text</label>
                    <input id="setFooter" placeholder="e.g. Photography by EventLens">
                </div>

                <div class="settings-group">
                    <div class="settings-title"><i class="fa-solid fa-ruler-combined"></i> Sizing Controls</div>
                    
                    <div class="row" style="justify-content:space-between; margin-bottom:5px;">
                        <label class="text-sm">Logo Size (Mobile)</label>
                        <input id="sizeLogoMob" class="range-val" value="80">
                    </div>
                    <input type="range" min="40" max="150" value="80" oninput="$('#sizeLogoMob').value=this.value; updatePreview()" style="margin-bottom:12px;">

                    <div class="row" style="justify-content:space-between; margin-bottom:5px;">
                        <label class="text-sm">Logo Size (Desktop)</label>
                        <input id="sizeLogoDesk" class="range-val" value="120">
                    </div>
                    <input type="range" min="50" max="300" value="120" oninput="$('#sizeLogoDesk').value=this.value; updatePreview()" style="margin-bottom:12px;">

                    <hr style="border:0; border-top:1px solid #333; margin: 15px 0;">

                    <div class="row" style="justify-content:space-between; margin-bottom:5px;">
                        <label class="text-sm">Banner Height (Mobile)</label>
                        <input id="sizeBanMob" class="range-val" value="200">
                    </div>
                    <input type="range" min="100" max="400" value="200" oninput="$('#sizeBanMob').value=this.value; updatePreview()" style="margin-bottom:12px;">

                    <div class="row" style="justify-content:space-between; margin-bottom:5px;">
                        <label class="text-sm">Banner Height (Desktop)</label>
                        <input id="sizeBanDesk" class="range-val" value="350">
                    </div>
                    <input type="range" min="200" max="600" value="350" oninput="$('#sizeBanDesk').value=this.value; updatePreview()">
                </div>

                <div class="settings-group">
                    <div class="settings-title"><i class="fa-solid fa-palette"></i> Theme</div>
                    <label class="text-sm">Primary Color</label>
                    <div class="row" style="margin-bottom: 12px;">
                        <input type="color" id="setColorPicker" style="width: 50px; height: 45px; padding: 0;" onchange="$('#setColor').value=this.value">
                        <input id="setColor" placeholder="#00e676" onchange="$('#setColorPicker').value=this.value">
                    </div>
                    <label class="text-sm">Layout Style</label>
                    <select id="setLayout">
                        <option value="grid">Grid (Default)</option>
                        <option value="masonry">Masonry (Pinterest Style)</option>
                    </select>
                    <label class="text-sm" style="margin-top:10px; display:block;">Banner Opacity</label>
                    <div class="row">
                        <input type="range" id="setOpacity" min="0" max="0.9" step="0.1" value="0.3" oninput="$('#opacityVal').innerText=this.value" style="flex:1;">
                        <span id="opacityVal" class="text-sm">0.3</span>
                    </div>
                </div>

                <div style="margin-top: 30px; text-align: right;">
                    <button class="btn primary" onclick="saveSettings()" style="width: 100%;">Save All Settings</button>
                </div>
            </div>

            <!-- RIGHT: LIVE PREVIEW -->
            <div class="card" style="position: sticky; top: 20px; height: fit-content; text-align: center;">
                <div class="row" style="justify-content: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; margin-right: 15px;">Live Preview</h3>
                    <div style="background: #222; border-radius: 20px; padding: 4px; display: inline-flex;">
                        <button class="btn" id="btnPrevMob" onclick="setPreviewMode('mobile')" style="padding: 6px 12px; font-size: 12px; background: var(--primary); color: #000;">Mobile</button>
                        <button class="btn" id="btnPrevDesk" onclick="setPreviewMode('desktop')" style="padding: 6px 12px; font-size: 12px; background: transparent; color: #fff;">Desktop</button>
                    </div>
                </div>

                <div id="previewFrame" class="preview-frame mobile">
                    <!-- Default SVG fallback for Header -->
                    <div id="prevHeader" class="prev-header" style="background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'800\' height=\'400\' viewBox=\'0 0 800 400\'%3E%3Crect width=\'800\' height=\'400\' fill=\'%23333\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' fill=\'%23555\' font-size=\'24\' font-family=\'sans-serif\'%3EBanner Image%3C/text%3E%3C/svg%3E');">
                        <div class="prev-overlay">
                            <!-- Safe SVG Placeholder -->
                            <img id="prevLogo" class="prev-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg\' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%23333' stroke='%2300e676' stroke-width='4'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%23fff' font-family='sans-serif' font-size='14'%3ELOGO%3C/text%3E%3C/svg%3E">
                            <h2 id="prevTitle" class="prev-title">Event Title</h2>
                            <p id="prevWelcome" class="prev-welcome">Welcome Message Here</p>
                        </div>
                    </div>
                    <!-- Mock Content -->
                    <div style="padding: 15px; text-align: center;">
                        <div style="background: #222; height: 100px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: #555;">Search Box</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            <div style="background: #222; height: 100px; border-radius: 4px;"></div>
                            <div style="background: #222; height: 100px; border-radius: 4px;"></div>
                            <div style="background: #222; height: 100px; border-radius: 4px;"></div>
                            <div style="background: #222; height: 100px; border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

  </div>
</div>

<script>
/* ================= CONFIGURATION ================= */
const API_BASE = "https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod"; 
const COGNITO_DOMAIN = "https://ap-south-1mva8s6f3w.auth.ap-south-1.amazoncognito.com";
const CLIENT_ID = "6j3gec3kk0q0ktkals8cr8s367";
const HOSTED_UI = `${COGNITO_DOMAIN}/login?client_id=${CLIENT_ID}&response_type=code&scope=email+openid+profile&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}`;

/* ================= STATE MANAGEMENT ================= */
let idToken = localStorage.getItem('idToken');
let curCol = null;
let allCols = []; // Global Store for Collections
let curEvents = [];
let uploadQueue = [];
let currentPhotos = [];
let currentPhotoIndex = -1;
let previewMode = 'mobile';

/* ================= INITIALIZATION ================= */
window.addEventListener('load', async () => {
  const params = new URLSearchParams(location.search);
  if(params.has('code')){
    await exchangeCode(params.get('code'));
    return;
  }
  
  if(!idToken) {
    showView('vLogin');
  } else {
    $('#btnLogout').classList.remove('hidden');
    $('#userBadge').textContent = 'Photographer';
    $('#btnLogin').classList.add('hidden');
    route('dashboard'); 
  }
  
  document.addEventListener('keydown', (e) => {
      if(!$('#lightbox').classList.contains('open')) return;
      if(e.key === 'ArrowLeft') navLightbox(-1);
      if(e.key === 'ArrowRight') navLightbox(1);
      if(e.key === 'Escape') closeLightbox();
  });
});

/* ================= AUTHENTICATION ================= */
async function exchangeCode(code){
  showToast('Authenticating...', 'success');
  try {
    const res = await fetch(`${COGNITO_DOMAIN}/oauth2/token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: CLIENT_ID,
        code: code,
        redirect_uri: window.location.origin + window.location.pathname
      })
    });
    const data = await res.json();
    if(data.id_token){
      localStorage.setItem('idToken', data.id_token);
      window.location.href = window.location.origin + window.location.pathname; 
    } else {
      showToast('Login Failed', 'error');
    }
  } catch(e) { showToast(e.message, 'error'); }
}

function doLogin(){ location.href = HOSTED_UI; }
function doLogout() { localStorage.clear(); location.reload(); }

/* ================= API HELPERS ================= */
const $ = (s) => document.querySelector(s);
const showToast = (msg, type='success') => {
  const t = $('#toast'); 
  t.innerHTML = type === 'error' ? `<i class="fa-solid fa-triangle-exclamation"></i> ${msg}` : `<i class="fa-solid fa-check-circle"></i> ${msg}`;
  t.className = `show ${type}`;
  setTimeout(() => t.className = '', 3500);
};

async function api(path, body){
  const opts = {
    method: 'POST', 
    headers: { 'Authorization': `Bearer ${idToken}`, 'Content-Type': 'application/json' }
  };
  if(path.includes('account-status') || path.includes('get-collections') || path.includes('get-branding')) opts.method = 'GET';
  if(body) { opts.method = 'POST'; opts.body = JSON.stringify(body); } 

  const r = await fetch(`${API_BASE}${path}`, opts);
  if(!r.ok) throw new Error(`API Error ${r.status}`);
  return r.json();
}

/* ================= ROUTING & VIEWS ================= */
function route(dest){
  if(dest === 'dashboard'){
    loadDashboard();
    showView('vDash');
  }
}

function showView(id){
  document.querySelectorAll('.view').forEach(e => e.classList.remove('show'));
  const target = $(`#${id}`);
  if(target) target.classList.add('show');
  window.scrollTo(0,0);
}

function setTab(id){
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  // Use more specific selector to avoid selecting multiple buttons if IDs reused
  const tabBtn = document.querySelector(`.tab[onclick*="'${id}'"]`);
  if(tabBtn) tabBtn.classList.add('active');
  
  const content = $(`#${id}`);
  if(content) content.classList.add('active');
  
  // Only load if we have a valid collection
  if(curCol) {
      if(id === 'tGal') loadPhotos(true);
      if(id === 'tLeads') loadLeads();
      if(id === 'tClient') loadClientSelections();
      if(id === 'tSettings') loadSettings();
  }
}

/* ================= DASHBOARD ================= */
async function loadDashboard(){
  try {
    const [cData, sData] = await Promise.all([
        api('/get-collections'),
        api('/account-status').catch(()=>({})) 
    ]);

    // Store globally for indexed access
    allCols = (cData.Items || []).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

    // ✅ FIX: Calculate Real Totals from All Events
    let realTotalPhotos = 0;
    let realTotalStorage = 0;
    
    // First, sum up what's already in the collections response
    realTotalPhotos = allCols.reduce((sum, c) => sum + (c.total_photo_count || 0), 0);
    realTotalStorage = allCols.reduce((sum, c) => sum + (c.storage_bytes || 0), 0);

    // If counts seem low or 0, background fetch actual details
    if (allCols.length > 0) {
        // Trigger fetch in background to correct stats
        (async () => {
             let updatedP = 0;
             let updatedS = 0;
             
             // Create an array of promises for parallel execution
             const promises = allCols.map(async (col) => {
                try {
                    const evData = await api('/get-events', { collection_id: col.collection_id });
                    const evs = evData.events || [];
                    let cP = 0;
                    let cS = 0;
                    evs.forEach(e => { cP += (e.photo_count||0); cS += (e.storage_bytes||0); });
                    
                    // Update the local object
                    col.total_photo_count = cP; 
                    col.storage_bytes = cS;
                    
                    return { p: cP, s: cS };
                } catch(e) { return { p: 0, s: 0 }; }
             });

             const results = await Promise.all(promises);
             results.forEach(r => { updatedP += r.p; updatedS += r.s; });
             
             // Update Global UI
             $('#dPhotos').textContent = updatedP.toLocaleString();
             $('#dStorage').textContent = formatBytes(updatedS);
             
             // Re-render list with updated stats
             renderCollectionList();
        })();
    }
    
    // Update KPI Display (Initial)
    $('#dCols').textContent = allCols.length;
    $('#dPhotos').textContent = realTotalPhotos > 0 ? realTotalPhotos.toLocaleString() : "Computing...";
    $('#dStorage').textContent = realTotalStorage > 0 ? formatBytes(realTotalStorage) : "Computing...";
    
    renderCollectionList();
    
  } catch(e) { showToast(e.message, 'error'); }
}

function renderCollectionList() {
    const colList = $('#colList');
    if(allCols.length === 0) {
        colList.innerHTML = `<div style="text-align:center; padding: 40px; color:#555;">No collections found. Create one!</div>`;
        return;
    }

    // Modern Card List Layout
    colList.innerHTML = allCols.map((c, i) => `
      <div class="col-card" onclick="openCol(${i})">
          <div class="col-title">${escapeHtml(c.name)}</div>
          <div class="col-meta">
               <span><i class="fa-regular fa-calendar"></i> ${new Date(c.created_at).toLocaleDateString()}</span>
               <span><i class="fa-solid fa-images"></i> ${c.total_photo_count||0} Photos</span>
               <span><i class="fa-solid fa-database"></i> ${formatBytes(c.storage_bytes||0)}</span>
          </div>
          <div class="col-actions">
             <button class="btn secondary" style="padding: 8px 16px; font-size: 12px;">Manage</button>
             <button class="btn danger" onclick="event.stopPropagation(); delCol('${c.collection_id}')"><i class="fa-solid fa-trash"></i></button>
          </div>
      </div>
    `).join('');
}

function toggleNewCol(show){ show ? $('#newColBox').classList.remove('hidden') : $('#newColBox').classList.add('hidden'); }

async function createCollection(){
  const name = $('#ncName').value;
  if(!name) return;
  showToast('Creating...');
  await api('/upsert-collection', { name });
  toggleNewCol(false); $('#ncName').value = '';
  loadDashboard();
}

async function delCol(id){
  if(confirm("Permanently delete this collection?")){
    await api('/delete-collection', { collection_id: id });
    loadDashboard();
  }
}

// FIXED: Now accepts index to retrieve full object from global store
async function openCol(index){
  curCol = allCols[index]; // Full object with branding info
  
  if (curCol) {
      showView('vCol');
      const titleEl = $('#cdTitle');
      const idEl = $('#cdId');
      if (titleEl) titleEl.textContent = curCol.name;
      if (idEl) idEl.textContent = `ID: ${curCol.collection_id}`;
      
      setTab('tGal'); 
      loadEvents(); 
  } else {
      showToast("Error loading collection details", "error");
  }
}

/* ================= EVENT MANAGEMENT ================= */
async function loadEvents(){
  if(!curCol) return;
  try {
      const data = await api('/get-events', { collection_id: curCol.collection_id });
      curEvents = data.events || [];
      
      $('#tblEvents').innerHTML = curEvents.map(e => `
        <tr>
          <td><b>${escapeHtml(e.name)}</b></td>
          <td>${e.event_date || '-'}</td>
          <td>${e.photo_count || 0}</td>
          <td>${formatBytes(e.storage_bytes || 0)}</td>
          <td>
            <button class="btn secondary" style="padding:6px 12px;" onclick="editEvent('${e.event_id}', '${escapeHtml(e.name)}', '${e.event_date||''}')"><i class="fa-solid fa-pen"></i></button>
            <button class="btn danger" style="padding:6px 12px;" onclick="delEvent('${e.event_id}')"><i class="fa-solid fa-trash"></i></button>
          </td>
        </tr>
      `).join('');

      const opts = `<option value="">Select Event</option>` + curEvents.map(e => `<option value="${e.event_id}">${escapeHtml(e.name)}</option>`).join('');
      $('#galEventFilter').innerHTML = opts;
      $('#upEventSel').innerHTML = opts;
      $('#linkEventSel').innerHTML = `<option value="">Entire Collection</option>` + curEvents.map(e => `<option value="${e.event_id}">${escapeHtml(e.name)}</option>`).join('');
  } catch(e) { console.error("Error loading events", e); }
}

async function createNewEvent(){
  const name = $('#neName').value;
  const date = $('#neDate').value;
  if(!name) return showToast('Name required', 'error');
  await api('/upsert-event', { collection_id: curCol.collection_id, name, event_date: date });
  $('#neName').value = '';
  loadEvents();
  showToast('Event Added');
}

async function delEvent(eid){
  if(confirm('Delete event?')) {
    await api('/delete-event', { collection_id: curCol.collection_id, event_id: eid });
    loadEvents();
  }
}

function editEvent(id, name, date){
    $('#eeId').value = id;
    $('#eeName').value = name;
    $('#eeDate').value = date;
    $('#evEditForm').classList.remove('hidden');
    $('#evAddForm').classList.add('hidden');
}

function cancelEditEvent(){
    $('#evEditForm').classList.add('hidden');
    $('#evAddForm').classList.remove('hidden');
}

async function updateEvent(){
    const id = $('#eeId').value;
    const name = $('#eeName').value;
    const date = $('#eeDate').value;
    if(!name) return;
    await api('/upsert-event', { collection_id: curCol.collection_id, event_id: id, name, event_date: date });
    cancelEditEvent();
    loadEvents();
    showToast('Event Updated');
}

/* ================= GALLERY & LIGHTBOX ================= */
let photosNext = null;
async function loadPhotos(reset=false, loadMore=false){
  if(!curCol) return;
  if(reset) photosNext = null;
  
  const eid = $('#galEventFilter').value;
  const payload = { collection_id: curCol.collection_id };
  if(eid) payload.event_id = eid;
  if(loadMore && photosNext) payload.next_token = photosNext;

  try {
      const res = await api('/get-photos', payload);
      const photos = res.items || res.photos || []; 
      photosNext = res.nextToken; 

      if(reset) {
          $('#galGrid').innerHTML = '';
          currentPhotos = [];
      }
      
      currentPhotos = reset ? photos : currentPhotos.concat(photos);
      $('#galCount').textContent = `${currentPhotos.length} photos displayed`;
      
      const html = photos.map((p, idx) => {
          const globalIdx = reset ? idx : (currentPhotos.length - photos.length + idx);
          const url = p.thumbnail_url || p.url;
          return `
            <div class="ph-card" onclick="openLightbox(${globalIdx})">
              <img src="${url}" loading="lazy" decoding="async" onload="this.classList.add('loaded')" onerror="this.style.display='none'">
            </div>
          `;
      }).join('');
      
      $('#galGrid').insertAdjacentHTML('beforeend', html);
      if(photosNext) $('#btnLoadMore').classList.remove('hidden'); else $('#btnLoadMore').classList.add('hidden');
  } catch(e) { console.error("Error loading photos", e); }
}

function openLightbox(index) {
    currentPhotoIndex = index;
    const p = currentPhotos[index];
    if(p) {
        $('#lbImage').src = p.url; 
        $('#lightbox').classList.add('open');
    }
}
function closeLightbox() { $('#lightbox').classList.remove('open'); }
function navLightbox(dir) {
    let newIndex = currentPhotoIndex + dir;
    if(newIndex < 0) newIndex = currentPhotos.length - 1;
    if(newIndex >= currentPhotos.length) newIndex = 0;
    openLightbox(newIndex);
}

async function downloadCurrentPhoto() {
    const p = currentPhotos[currentPhotoIndex];
    if(!p) return;
    try {
        const response = await fetch(p.url);
        const blob = await response.blob();
        saveAs(blob, p.photo_id ? (p.photo_id.split('___').pop()) : 'photo.jpg');
    } catch(e) { window.open(p.url, '_blank'); }
}

async function deleteCurrentPhoto() {
    if(!confirm("Delete?")) return;
    const p = currentPhotos[currentPhotoIndex];
    try {
        await api('/delete-photo', { photo_id: p.photo_id, collection_id: curCol.collection_id });
        currentPhotos.splice(currentPhotoIndex, 1);
        if(currentPhotos.length === 0) closeLightbox(); else navLightbox(0); 
        loadPhotos(true); showToast('Deleted');
    } catch(e) { console.error(e); }
}

/* ================= UPLOAD LOGIC ================= */
function queueFiles(fileList){
  const files = Array.from(fileList);
  if(!files.length) return;
  files.forEach(f => { uploadQueue.push(f); });
  renderQueue();
}
function renderQueue(){
    $('#uploadQueueBox').classList.remove('hidden');
    $('#queueCount').textContent = uploadQueue.length;
    $('#queueList').innerHTML = uploadQueue.map(f => `<div style="font-size:12px; border-bottom:1px solid #333; padding:4px;">${f.name} <span class="text-muted">(${formatBytes(f.size)})</span></div>`).join('');
}

async function startUploadProcess(){
  const eventId = $('#upEventSel').value;
  if(!eventId) return showToast('Select Event!', 'error');
  if(uploadQueue.length === 0) return showToast('No files', 'error');

  $('#btnStartUpload').disabled = true;
  $('#btnStartUpload').textContent = 'Uploading...';
  $('#upProgress').classList.remove('hidden');
  
  const BATCH_SIZE = 50; 
  let processedCount = 0;
  const total = uploadQueue.length;

  for (let i = 0; i < total; i += BATCH_SIZE) {
    const chunk = uploadQueue.slice(i, i + BATCH_SIZE);
    $('#upStatusText').textContent = `Uploading Batch ${Math.ceil((i+1)/BATCH_SIZE)}/${Math.ceil(total/BATCH_SIZE)}`;
    $('#upPct').textContent = `${Math.round((processedCount / total) * 100)}%`;
    await processBatch(chunk, eventId);
    processedCount += chunk.length;
    $('#upBar').style.width = `${Math.round((processedCount / total) * 100)}%`;
  }

  showToast('Done!');
  $('#upStatusText').textContent = 'Done!';
  uploadQueue = []; renderQueue();
  $('#uploadQueueBox').classList.add('hidden');
  $('#btnStartUpload').disabled = false;
  $('#btnStartUpload').textContent = 'Start Upload';
  loadPhotos(true);
}

async function processBatch(files, eventId){
  const metaList = await Promise.all(files.map(async f => {
      let procFile = f;
      if(f.name.toLowerCase().endsWith('.heic')){
          try {
             const blob = await heic2any({ blob: f, toType: "image/jpeg", quality: 0.8 });
             procFile = new File([blob], f.name.replace(/\.heic$/i, ".jpg"), { type: "image/jpeg" });
          } catch(e) {}
      }
      const hash = await computeHash(procFile);
      const cleanName = procFile.name.replace(/[^a-zA-Z0-9.]/g, '_');
      return { name: cleanName, type: 'image/jpeg', size: procFile.size, hash: hash, fileObj: procFile };
  }));

  const payload = { collection_id: curCol.collection_id, event_id: eventId, files: metaList.map(m => ({ name: m.name, type: m.type, size: m.size, hash: m.hash })) };
  
  try {
      const res = await api('/generate-upload-urls', payload);
      const uploadPromises = res.urls.map(u => {
        const original = metaList.find(m => m.hash === u.hash); 
        if(!original) return null;
        return fetch(u.uploadURL, {
          method: 'PUT', body: original.fileObj,
          headers: { 'Content-Type': 'image/jpeg', 'x-amz-meta-original-hash': u.hash }
        });
      });
      await Promise.all(uploadPromises);
  } catch(e) { console.error(e); }
}

async function computeHash(file) {
  const buf = await file.arrayBuffer();
  const hash = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}
function copyStaffLink() {
    const baseUrl = window.location.origin + "/EventLens_Staff_Upload.html";
    const eid = $('#upEventSel').value;
    let url = `${baseUrl}?cid=${curCol.collection_id}`;
    if(eid) url += `&eid=${eid}`;
    const tempInput = document.createElement("input");
    tempInput.value = url;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    document.body.removeChild(tempInput);
    showToast('Link Copied!');
}

/* ================= LINK GENERATION ================= */
async function generateLink(){
  const eid = $('#linkEventSel').value;
  const expiry = $('#linkExpiry').value;
  const pin = $('#linkPin').value;
  try {
    const res = await api('/generate-search-link', {
       collection_id: curCol.collection_id, event_ids: eid ? [eid] : [], expiry_hours: parseInt(expiry), password: pin
    });
    // ✅ FIX: Robust check for link_id
    const linkId = res.link_id || res.id || (res.body ? JSON.parse(res.body).link_id : null);
    if(!linkId) throw new Error("No Link ID");
    
    const finalUrl = `${window.location.origin}/index.html?linkId=${linkId}&cid=${curCol.collection_id}`;
    $('#finalLink').value = finalUrl;
    $('#finalLinkBtn').href = finalUrl;
    $('#linkRes').classList.remove('hidden');
    showToast('Generated!');
  } catch(e) { showToast(e.message, 'error'); }
}
function copyLink(){
  const el = $('#finalLink'); el.select(); document.execCommand('copy'); showToast('Copied');
}

// Client Link Generation (New)
async function generateClientLink(){
  const pin = $('#clientPin').value;
  if(!pin) return showToast('Set a PIN for client access', 'error');
  try {
    const res = await api('/generate-search-link', {
       collection_id: curCol.collection_id, expiry_hours: 87600, password: pin, type: 'client'
    });
    const linkId = res.link_id || res.id;
    if(!linkId) throw new Error("No Link ID");
    const finalUrl = `${window.location.origin}/client-gallery.html?id=${linkId}`;
    $('#clientFinalLink').value = finalUrl;
    $('#clientLinkBtn').href = finalUrl;
    $('#clientLinkRes').classList.remove('hidden');
    showToast('Client Link Generated!');
  } catch(e) { showToast(e.message, 'error'); }
}
function copyClientLink(){
  const el = $('#clientFinalLink'); el.select(); document.execCommand('copy'); showToast('Copied');
}

/* ================= CLIENT SELECTIONS & LEADS ================= */
async function loadClientSelections() {
   // Placeholder until backend ClientGalleryHandler sends data format
   // Just to show structure
   $('#tblSelections').innerHTML = `<tr><td colspan="3" align="center" class="text-muted">Waiting for client activity...</td></tr>`;
}

async function loadLeads(){
  $('#tblLeads').innerHTML = `<tr><td colspan="4" align="center">Loading...</td></tr>`;
  try {
    const res = await api('/save-details', { action: 'list', collection_id: curCol.collection_id });
    const leads = Array.isArray(res) ? res : (res.items || res.leads || []);
    if(leads.length === 0) {
        $('#tblLeads').innerHTML = `<tr><td colspan="4" align="center" class="text-muted">No guest searches yet.</td></tr>`;
        return;
    }
    
    // Merge by Phone
    const grouped = {};
    leads.forEach(l => {
        const key = l.mobile || 'Unknown';
        if(!grouped[key]) grouped[key] = { ...l, history: [] };
        grouped[key].history.push(l);
    });

    const rows = Object.values(grouped).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

    $('#tblLeads').innerHTML = rows.map((l, i) => `
      <tr class="lead-row" onclick="$('#hist-${i}').classList.toggle('open')">
        <td>
           <div style="font-weight:700">${escapeHtml(l.name || 'Unknown')}</div>
           <div class="text-sm text-muted">Latest: ${new Date(l.timestamp).toLocaleString()}</div>
        </td>
        <td>${l.mobile || '-'}</td>
        <td><span class="tag-pill">${l.history.length} Searches</span> <i class="fa-solid fa-chevron-down" style="font-size:10px;"></i></td>
        <td><a href="${l.selfie_url}" target="_blank"><img src="${l.selfie_url}" style="width:36px; height:36px; border-radius:50%; border:1px solid #444; object-fit:cover;"></a></td>
      </tr>
      <tr id="hist-${i}" class="lead-history" style="background: rgba(255,255,255,0.02);">
        <td colspan="4" style="padding: 10px;">
            <div style="font-size:11px; color:#aaa; margin-bottom:5px;">HISTORY:</div>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                ${l.history.map(h => `
                    <div class="hist-item">
                        <img src="${h.selfie_url}" style="width:30px; height:30px; border-radius:4px; object-fit:cover;">
                        <div>
                            <div style="font-weight:600; color:#fff;">${h.match_count} Matches</div>
                            <div style="font-size:10px;">${new Date(h.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </td>
      </tr>
    `).join('');
  } catch(e) { $('#tblLeads').innerHTML = `<tr><td colspan="4">Error loading</td></tr>`; }
}

/* ================= LIVE PREVIEW & SETTINGS ================= */
function setPreviewMode(mode) {
    previewMode = mode;
    const frame = $('#previewFrame');
    if(mode === 'mobile') {
        frame.className = 'preview-frame mobile';
        $('#btnPrevMob').style.background = 'var(--primary)'; $('#btnPrevMob').style.color='#000';
        $('#btnPrevDesk').style.background = 'transparent'; $('#btnPrevDesk').style.color='#fff';
    } else {
        frame.className = 'preview-frame desktop';
        $('#btnPrevDesk').style.background = 'var(--primary)'; $('#btnPrevDesk').style.color='#000';
        $('#btnPrevMob').style.background = 'transparent'; $('#btnPrevMob').style.color='#fff';
    }
    updatePreview();
}

function updatePreview() {
    $('#prevTitle').textContent = $('#setColName').value || 'Event Title';
    $('#prevWelcome').textContent = $('#setWelcome').value || '';
    
    const headImgSrc = $('#setHeadImg').dataset.localPreview || $('#setHeadImg').dataset.signedUrl;
    const logoImgSrc = $('#setLogo').dataset.localPreview || $('#setLogo').dataset.signedUrl;

    if(headImgSrc) $('#prevHeader').style.backgroundImage = `url('${headImgSrc}')`;
    
    const prevLogo = $('#prevLogo');
    if(logoImgSrc) { 
        prevLogo.src = logoImgSrc; 
        prevLogo.style.display = 'block'; 
        prevLogo.onerror = function() { this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%23333' stroke='%2300e676' stroke-width='4'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%23fff' font-family='sans-serif' font-size='14'%3ELOGO%3C/text%3E%3C/svg%3E"; };
    } else prevLogo.style.display = 'none';

    // Sizes
    if(previewMode === 'mobile') {
        $('#prevLogo').style.width = `${$('#sizeLogoMob').value}px`;
        $('#prevLogo').style.height = `${$('#sizeLogoMob').value}px`;
        $('#prevHeader').style.height = `${$('#sizeBanMob').value}px`;
    } else {
        $('#prevLogo').style.width = `${$('#sizeLogoDesk').value}px`;
        $('#prevLogo').style.height = `${$('#sizeLogoDesk').value}px`;
        $('#prevHeader').style.height = `${$('#sizeBanDesk').value}px`;
    }
}

function manualUpdate(targetId) {
    const input = document.getElementById(targetId);
    delete input.dataset.localPreview; delete input.dataset.signedUrl;
    updatePreview();
}

async function loadSettings(){
    $('#setColName').value = curCol.name;
    if(curCol.branding) {
        const b = curCol.branding;
        $('#setHeadImg').value = b.header_img || '';
        $('#setLogo').value = b.logo || '';
        $('#setFooter').value = b.footer || '';
        $('#setWelcome').value = b.welcome_msg || '';
        $('#setColor').value = b.color || '#00e676';
        $('#setColorPicker').value = b.color || '#00e676';
        $('#setLayout').value = b.layout || 'grid';
        $('#setOpacity').value = b.overlay_opacity || 0.3;
        $('#opacityVal').innerText = b.overlay_opacity || 0.3;
        
        $('#sizeLogoMob').value = b.logo_size_mob || '80';
        $('#sizeLogoDesk').value = b.logo_size_desk || '120';
        $('#sizeBanMob').value = b.banner_h_mob || '200';
        $('#sizeBanDesk').value = b.banner_h_desk || '350';

        try {
            const res = await api(`/get-branding?cid=${curCol.collection_id}`);
            if(res.header_img) document.getElementById('setHeadImg').dataset.signedUrl = res.header_img;
            if(res.logo) document.getElementById('setLogo').dataset.signedUrl = res.logo;
        } catch(e) {}
        updatePreview();
    }
}

async function saveSettings() {
    const newName = $('#setColName').value;
    const branding = {
        header_img: $('#setHeadImg').value, logo: $('#setLogo').value, footer: $('#setFooter').value,
        welcome_msg: $('#setWelcome').value, color: $('#setColor').value, layout: $('#setLayout').value,
        overlay_opacity: $('#setOpacity').value,
        logo_size_mob: $('#sizeLogoMob').value, logo_size_desk: $('#sizeLogoDesk').value,
        banner_h_mob: $('#sizeBanMob').value, banner_h_desk: $('#sizeBanDesk').value
    };
    
    showToast('Saving...');
    try {
        await api('/upsert-collection', { collection_id: curCol.collection_id, name: newName, branding: branding });
        curCol.name = newName; curCol.branding = branding;
        $('#cdTitle').textContent = newName;
        showToast('Saved!');
    } catch(e) { showToast(e.message, 'error'); }
}

async function uploadAsset(input, targetId) {
    const file = input.files[0];
    if(!file) return;
    const localUrl = URL.createObjectURL(file);
    const targetInput = document.getElementById(targetId);
    targetInput.dataset.localPreview = localUrl; delete targetInput.dataset.signedUrl;
    updatePreview();
    
    let eventIdToUse = null;
    if(!curEvents || curEvents.length === 0) { 
        try { const data = await api('/get-events', { collection_id: curCol.collection_id }); curEvents = data.events || []; } catch(e) {}
    }
    if(curEvents.length > 0) eventIdToUse = curEvents[0].event_id;
    else return showToast('Create event first', 'error');
    
    showToast('Uploading...');
    try {
        const cleanName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
        const hash = 'branding_' + Date.now(); 
        const res = await api('/generate-upload-urls', {
            collection_id: curCol.collection_id, event_id: eventIdToUse,
            files: [{ name: "branding_"+cleanName, type: file.type, size: file.size, hash: hash }]
        });
        
        if(res.urls && res.urls.length > 0) {
            const u = res.urls[0];
            await fetch(u.uploadURL, { method: 'PUT', body: file, headers: { 'Content-Type': 'image/jpeg', 'x-amz-meta-original-hash': u.hash } });
            targetInput.value = u.uploadURL.split('?')[0]; 
            showToast('Uploaded!');
        }
    } catch(e) { console.error(e); showToast('Upload failed', 'error'); }
}

/* ================= UTILS ================= */
function escapeHtml(text) { if (!text) return text; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
function formatBytes(bytes=0){ if(!+bytes) return '0 B'; const k=1024, sizes=['Bytes','KB','MB','GB','TB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return `${parseFloat((bytes/Math.pow(k,i)).toFixed(2))} ${sizes[i]}`; }
</script>
</body>
</html>
