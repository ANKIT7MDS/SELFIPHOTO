<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Client Gallery – EventLens</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary: #00e676;
            --bg: #050505;
            --panel: #111;
            --text: #ffffff;
            --text-muted: #a1a1aa;
            --border: #27272a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow-x: hidden;
            user-select: none;
        }

        /* LOGIN VIEW */
        #authView {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: radial-gradient(circle at center, #111 0%, #050505 100%);
        }
        .login-card {
            background: var(--panel);
            padding: 40px;
            border-radius: 24px;
            border: 1px solid var(--border);
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
        }
        .login-card h1 { font-family: 'Outfit', sans-serif; font-size: 28px; margin-bottom: 8px; font-weight: 800; }
        .login-card p { color: var(--text-muted); font-size: 14px; margin-bottom: 30px; line-height: 1.5; }
        .pin-input {
            background: #000;
            border: 1px solid var(--border);
            color: var(--primary);
            padding: 16px;
            border-radius: 14px;
            width: 100%;
            font-size: 22px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 20px;
            font-weight: 800;
            transition: 0.3s;
        }
        .pin-input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 230, 118, 0.2); }
        
        .btn-open {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 16px;
            border-radius: 14px;
            width: 100%;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-open:active { transform: scale(0.96); }

        /* MAIN GALLERY VIEW */
        #galleryView { display: none; }

        /* HEADER & BRANDING */
        .hero {
            height: 350px;
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            background-color: #111;
        }
        .hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent 20%, rgba(0,0,0,0.95) 90%);
        }
        .brand-content {
            position: relative;
            z-index: 2;
            text-align: center;
            padding-bottom: 40px;
            width: 100%;
            padding-inline: 20px;
        }
        .brand-logo {
            width: 90px; height: 90px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            background: #000;
            margin-bottom: 15px;
            object-fit: cover;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .brand-title { font-family: 'Outfit', sans-serif; font-size: 26px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }

        /* FILTERS BAR */
        .filter-bar {
            position: sticky;
            top: 0;
            background: rgba(5,5,5,0.85);
            backdrop-filter: blur(20px);
            z-index: 100;
            padding: 14px;
            display: flex;
            justify-content: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }
        .chip {
            padding: 10px 20px;
            border-radius: 50px;
            background: var(--panel);
            border: 1px solid var(--border);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chip.active { background: var(--primary); color: #000; border-color: var(--primary); transform: scale(1.05); }

        /* GRID */
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            padding: 5px;
        }
        @media (max-width: 768px) { .grid { grid-template-columns: repeat(2, 1fr); } }
        
        .ph-card {
            aspect-ratio: 1;
            background: #111;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border-radius: 4px;
        }
        .ph-card img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.6s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .ph-card:hover img { transform: scale(1.1); }
        .ph-card.is-selected { border: 2px solid var(--primary); }

        .ph-actions {
            position: absolute;
            top: 10px; right: 10px;
            display: flex; flex-direction: column; gap: 8px;
            z-index: 5;
        }
        .action-dot {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 12px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .action-dot.selected { color: var(--primary); border-color: var(--primary); }
        .action-dot.fav { color: #ff4081; border-color: #ff4081; }

        /* FOOTER / SUBMIT BAR */
        .submit-bar {
            position: fixed;
            bottom: 24px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--primary);
            color: #000;
            padding: 16px 32px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            box-shadow: 0 15px 35px rgba(0, 230, 118, 0.3);
            z-index: 1000;
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .submit-bar.show { transform: translateX(-50%) translateY(0); }

        /* LIGHTBOX */
        #lightbox {
            position: fixed; inset: 0;
            background: #000;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }
        .lb-header { 
            padding: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            position: absolute; top: 0; width: 100%; z-index: 10;
        }
        .lb-content { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .lb-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .lb-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1); color: #fff; border-radius: 50%;
            cursor: pointer; z-index: 5;
        }
        .lb-nav.prev { left: 20px; }
        .lb-nav.next { right: 20px; }

        .lb-footer {
            padding: 20px 20px 40px;
            display: flex;
            justify-content: center;
            gap: 40px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            position: absolute; bottom: 0; width: 100%;
        }
        .lb-btn {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            color: var(--text-muted); cursor: pointer; font-size: 11px;
        }
        .lb-btn i { font-size: 26px; }
        .lb-btn.active-sel { color: var(--primary); }
        .lb-btn.active-fav { color: #ff4081; }

        #toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: #1c1c1e; color: #fff; padding: 12px 24px;
            border-radius: 50px; border: 1px solid var(--border);
            z-index: 9999; display: none; font-size: 13px;
        }
    </style>
</head>
<body>

    <div id="toast"></div>

    <!-- 1. LOGIN VIEW -->
    <div id="authView">
        <div class="login-card">
            <h1>Gallery Access</h1>
            <p>Photographer dwara diya gaya PIN yahan enter karein.</p>
            <input type="tel" id="pinInput" class="pin-input" maxlength="6" placeholder="••••">
            <button class="btn-open" onclick="accessGallery()">Unlock Now <i class="fa-solid fa-lock-open"></i></button>
        </div>
    </div>

    <!-- 2. GALLERY VIEW -->
    <div id="galleryView">
        <div class="hero" id="heroBanner">
            <div class="hero-overlay"></div>
            <div class="brand-content">
                <img src="" id="brandLogo" class="brand-logo" onerror="this.style.display='none'">
                <h2 class="brand-title" id="brandTitle">Loading...</h2>
                <p id="welcomeMsg" style="font-size: 13px; opacity: 0.8; margin-top: 5px;"></p>
            </div>
        </div>

        <div class="filter-bar">
            <div class="chip active" onclick="filterGallery('all', this)"><i class="fa-solid fa-grid-2"></i> All</div>
            <div class="chip" onclick="filterGallery('selected', this)"><i class="fa-solid fa-circle-check"></i> Selected (<span id="countSel">0</span>)</div>
            <div class="chip" onclick="filterGallery('fav', this)"><i class="fa-solid fa-heart"></i> Favorites (<span id="countFav">0</span>)</div>
        </div>

        <div class="grid" id="photoGrid"></div>

        <div class="submit-bar" id="submitBar" onclick="submitSelections()">
            <span>Send Selection</span>
            <i class="fa-solid fa-paper-plane"></i>
        </div>
    </div>

    <!-- 3. LIGHTBOX -->
    <div id="lightbox">
        <div class="lb-header">
            <button onclick="closeLightbox()" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            <div id="lbCounter" style="font-size: 14px;">0 / 0</div>
            <div style="width: 24px;"></div>
        </div>
        <div class="lb-content" id="lbContent">
            <div class="lb-nav prev" onclick="navLightbox(-1)"><i class="fa-solid fa-chevron-left"></i></div>
            <!-- FIXED: Removed all security policies to match standard behavior -->
            <img src="" id="lbImg" class="lb-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNDQ0IiBzdHJva2Utd2lkdGg9IjIiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiIHJ5PSIyIi8+PGNpcmNsZSBjeD0iOC41IiBjeT0iOC41IiByPSIxLjUiLz48cG9seWxpbmUgcG9pbnRzPSIyMSAxNSAxNiAxMCA1IDIxIi8+PC9zdmc+'">
            <div class="lb-nav next" onclick="navLightbox(1)"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
        <div class="lb-footer">
            <div class="lb-btn" id="lbBtnSel" onclick="toggleChoice('selected')">
                <i class="fa-solid fa-circle-check"></i>
                <span>Select for Album</span>
            </div>
            <div class="lb-btn" id="lbBtnFav" onclick="toggleChoice('fav')">
                <i class="fa-solid fa-heart"></i>
                <span>Favorite</span>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod/client-api";
        const urlParams = new URLSearchParams(window.location.search);
        
        const collectionId = urlParams.get('cid') || urlParams.get('collection_id') || urlParams.get('id');
        const linkId = urlParams.get('id') || urlParams.get('linkId'); 
        
        let allPhotos = [];
        let selections = {}; 
        let currentFilter = 'all';
        let currentIdx = 0;

        // 1. ACCESS GALLERY
        async function accessGallery() {
            const pin = document.getElementById('pinInput').value;
            if(!pin) return showToast("PIN enter karein", "error");

            if(!collectionId) return showToast("Invalid Link: No Collection ID found", "error");

            showToast("Opening Gallery...", "info");

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: "get_client_view", 
                        payload: {
                            collection_id: collectionId 
                        }
                    })
                });

                const data = await res.json();
                
                if(!res.ok) throw new Error(data.message || "Failed to load");
                
                let parsedData = data;
                if (typeof data.body === 'string') {
                    try { parsedData = JSON.parse(data.body); } catch(e) {}
                } else if (data.body) {
                    parsedData = data.body;
                }

                initGallery(parsedData);

            } catch (err) {
                console.error(err);
                showToast(err.message || "Error loading gallery", "error");
            }
        }

        // 2. INITIALIZE
        function initGallery(data) {
            allPhotos = data.photos || data.items || [];
            const settings = data.settings || {};
            const branding = data.branding || {}; 
            
            if(branding.color) document.documentElement.style.setProperty('--primary', branding.color);
            document.getElementById('brandTitle').textContent = data.collection_name || "Event Gallery"; 
            
            allPhotos.forEach(p => {
                if(p.status) {
                    selections[p.id] = { 
                        selected: p.status.selected || false, 
                        fav: p.status.fav || false
                    };
                }
            });

            renderGrid();
            updateCounters();

            document.getElementById('authView').style.display = 'none';
            document.getElementById('galleryView').style.display = 'block';
        }

        // 3. RENDER
        function renderGrid() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';

            const filtered = allPhotos.filter(p => {
                if(currentFilter === 'all') return true;
                const s = selections[p.id] || {};
                if(currentFilter === 'selected') return s.selected;
                if(currentFilter === 'fav') return s.fav;
                return true;
            });

            if(filtered.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#555;">
                    <i class="fa-regular fa-images" style="font-size:32px; margin-bottom:10px; opacity:0.5;"></i><br>
                    No photos found.
                </div>`;
            }

            filtered.forEach((p, idx) => {
                const s = selections[p.id] || {};
                const card = document.createElement('div');
                card.className = `ph-card ${s.selected ? 'is-selected' : ''}`;
                const originalIndex = allPhotos.findIndex(x => x.id === p.id);
                card.onclick = () => openLightbox(originalIndex);
                
                // FIXED: Removed all extra policies to avoid S3 blocks
                card.innerHTML = `
                    <img src="${p.thumb || p.url}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNDQ0IiBzdHJva2Utd2lkdGg9IjIiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiIHJ5PSIyIi8+PGNpcmNsZSBjeD0iOC41IiBjeT0iOC41IiByPSIxLjUiLz48cG9seWxpbmUgcG9pbnRzPSIyMSAxNSAxNiAxMCA1IDIxIi8+PC9zdmc+'">
                    <div class="ph-actions">
                        ${s.selected ? '<div class="action-dot selected"><i class="fa-solid fa-check"></i></div>' : ''}
                        ${s.fav ? '<div class="action-dot fav"><i class="fa-solid fa-heart"></i></div>' : ''}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // 4. ACTIONS
        function toggleChoice(type) {
            const photo = allPhotos[currentIdx];
            const pid = photo.id;
            
            if(!selections[pid]) selections[pid] = { selected: false, fav: false };
            selections[pid][type] = !selections[pid][type];
            
            updateLightboxUI();
            updateCounters();
            renderGrid();
            
            syncWithServer(pid, selections[pid]);
        }

        async function syncWithServer(photoId, statusObj) {
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: "update_selection", 
                        payload: {
                            collection_id: collectionId, 
                            photo_id: photoId,
                            status: statusObj
                        }
                    })
                });
            } catch(e) { console.error("Sync failed", e); }
        }

        function updateCounters() {
            let sCount = 0, fCount = 0;
            Object.values(selections).forEach(s => {
                if(s.selected) sCount++;
                if(s.fav) fCount++;
            });
            document.getElementById('countSel').textContent = sCount;
            document.getElementById('countFav').textContent = fCount;
            document.getElementById('submitBar').classList.toggle('show', sCount > 0 || fCount > 0);
        }

        function filterGallery(type, el) {
            currentFilter = type;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderGrid();
        }

        // 5. LIGHTBOX
        function openLightbox(idx) {
            currentIdx = idx;
            const p = allPhotos[idx];
            
            // Clean URL without timestamp to avoid signature issues
            const imgSrc = p.url;

            document.getElementById('lbImg').src = imgSrc;
            document.getElementById('lbCounter').textContent = `${idx + 1} / ${allPhotos.length}`;
            updateLightboxUI();
            document.getElementById('lightbox').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function navLightbox(dir) {
            currentIdx += dir;
            if(currentIdx < 0) currentIdx = allPhotos.length - 1;
            if(currentIdx >= allPhotos.length) currentIdx = 0;
            openLightbox(currentIdx);
        }

        function updateLightboxUI() {
            const pid = allPhotos[currentIdx].id;
            const s = selections[pid] || { selected: false, fav: false };
            
            const btnSel = document.getElementById('lbBtnSel');
            const btnFav = document.getElementById('lbBtnFav');

            btnSel.className = s.selected ? 'lb-btn active-sel' : 'lb-btn';
            btnFav.className = s.fav ? 'lb-btn active-fav' : 'lb-btn';
            
            // Text update optional
            btnSel.querySelector('span').textContent = s.selected ? "Selected" : "Select for Album";
        }

        // 6. SUBMIT
        function submitSelections() {
            alert("Great! Your selections have been saved and sent to the photographer.");
        }

        // Utils
        function showToast(msg, type = "success") {
            const t = document.getElementById('toast');
            t.innerHTML = msg;
            t.style.display = 'block';
            t.style.borderColor = type === 'error' ? '#f44336' : 'var(--primary)';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // Keys
        document.addEventListener('keydown', (e) => {
            if(document.getElementById('lightbox').style.display === 'flex') {
                if(e.key === 'ArrowRight') navLightbox(1);
                if(e.key === 'ArrowLeft') navLightbox(-1);
                if(e.key === 'Escape') closeLightbox();
            }
        });
    </script>
</body>
</html>
