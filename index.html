<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>EventLens – Smart AI Gallery</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #050505; --card: #121212; --surface: #1e1e1e;
      --accent: #00e676; --accent-dark: #00b35c; --accent-soft: rgba(0, 230, 118, 0.15);
      --text: #ffffff; --muted: #a0a0a0; --border: #333;
      --font-main: 'Plus Jakarta Sans', sans-serif;
      --overlay-op: 0.4;
      
      /* Dynamic Vars */
      --logo-size: 80px; 
      --banner-height: 220px;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; display: flex; flex-direction: column; padding-bottom: 80px; }

    /* --- HEADER & BRANDING --- */
    header { 
        position: relative; height: var(--banner-height); overflow: hidden; 
        background-color: #222; background-size: cover; background-position: center;
        transition: height 0.3s ease; border-bottom: 1px solid var(--border);
    }
    .header-overlay {
        position: absolute; inset: 0; 
        background: linear-gradient(to bottom, rgba(0,0,0,var(--overlay-op)), #050505);
        display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; text-align: center; align-items: center;
    }
    .brand-logo {
        width: var(--logo-size); height: var(--logo-size);
        border-radius: 50%; border: 3px solid var(--accent);
        object-fit: cover; margin-bottom: 10px; background: #000;
        display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    .welcome-text {
        font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.9); margin-bottom: 4px; 
        letter-spacing: 0.5px; text-transform: uppercase; display: none;
    }
    .brand-title { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; text-shadow: 0 2px 10px rgba(0,0,0,0.8); margin: 0; }

    /* --- MAIN CONTAINER --- */
    .container { max-width: 1000px; margin: 0 auto; padding: 16px; width: 100%; position: relative; z-index: 2; }

    /* --- SEARCH BOX --- */
    .search-card {
        background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 30px 20px;
        text-align: center; margin-top: -40px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        backdrop-filter: blur(10px);
    }
    .search-icon { font-size: 40px; color: var(--accent); margin-bottom: 15px; }
    .btn-main {
        background: var(--accent); color: #000; border: none; padding: 16px 32px; border-radius: 50px;
        font-size: 16px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 10px;
        transition: transform 0.2s; box-shadow: 0 4px 15px var(--accent-soft);
    }
    .btn-main:active { transform: scale(0.96); }

    /* --- GALLERY CONTROLS --- */
    .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 20px; }
    
    .tag-pill { background: var(--surface); color: var(--muted); padding: 6px 14px; border-radius: 20px; font-size: 13px; white-space: nowrap; border: 1px solid var(--border); cursor: pointer; }
    .tag-pill.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 600; }

    /* --- GRID --- */
    .grid { 
        display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 6px; 
        transition: opacity 0.3s;
    }
    /* Mobile optimization for grid */
    @media (max-width: 480px) {
        .grid { grid-template-columns: repeat(3, 1fr); gap: 4px; }
    }

    .photo-item { 
        aspect-ratio: 1; background: #1a1a1a; border-radius: 8px; overflow: hidden; position: relative; 
        cursor: pointer; -webkit-tap-highlight-color: transparent; 
    }
    /* Ensure image fills the box */
    .photo-item img { 
        width: 100%; height: 100%; object-fit: cover; display: block; 
        transition: transform 0.3s; 
    }
    
    /* Selection State */
    .photo-item.selected img { opacity: 0.4; transform: scale(0.9); }
    .photo-item.selected::after {
        content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: #fff; font-size: 24px; background: var(--accent); 
        width: 40px; height: 40px; border-radius: 50%; 
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5); pointer-events: none;
    }
    .select-ring {
        position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; 
        border: 2px solid rgba(255,255,255,0.7); border-radius: 50%; pointer-events: none;
        display: none; /* Only show in select mode */
    }
    body.select-mode .select-ring { display: block; }
    body.select-mode .photo-item.selected .select-ring { background: var(--accent); border-color: var(--accent); }

    /* Favorite Icon */
    .fav-btn {
        position: absolute; bottom: 8px; right: 8px; 
        background: rgba(0,0,0,0.6); border: none; border-radius: 50%;
        width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
        color: #fff; cursor: pointer; z-index: 5; font-size: 14px;
        transition: all 0.2s;
    }
    .fav-btn.active { color: #ff4081; background: #fff; }
    .fav-btn:active { transform: scale(1.2); }

    /* --- RIBBON --- */
    .ribbon {
        position: absolute; top: 12px; left: -25px; width: 100px; height: 24px;
        background: #ff4081; color: #fff; font-size: 10px; font-weight: 700;
        display: flex; align-items: center; justify-content: center;
        transform: rotate(-45deg); box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        z-index: 10; pointer-events: none;
    }

    /* --- BOTTOM BAR (ACTIONS) --- */
    .action-bar {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150px);
        background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(12px);
        border: 1px solid var(--border); border-radius: 50px; padding: 10px 20px;
        display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100;
        width: 90%; max-width: 400px; justify-content: space-around;
    }
    .action-bar.visible { transform: translateX(-50%) translateY(0); }
    .act-btn { background: none; border: none; color: #fff; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; opacity: 0.7; }
    .act-btn i { font-size: 20px; }
    .act-btn:hover, .act-btn.active { opacity: 1; color: var(--accent); }

    /* --- LOAD MORE --- */
    .load-more-container { text-align: center; margin-top: 30px; margin-bottom: 40px; }
    .btn-load { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 10px 25px; border-radius: 30px; cursor: pointer; font-size: 14px; }
    .btn-load:hover { border-color: var(--accent); }

    /* --- MODALS --- */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal.open { display: flex; animation: fadeIn 0.3s; }
    
    .modal-card { background: var(--card); border: 1px solid var(--border); width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; text-align: center; position: relative; }
    .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #666; font-size: 20px; cursor: pointer; }
    
    .lead-input { width: 100%; padding: 14px; margin-bottom: 12px; background: #000; border: 1px solid #333; border-radius: 10px; color: #fff; font-size: 16px; }
    .lead-input:focus { border-color: var(--accent); }

    /* --- LIGHTBOX --- */
    .viewer { position: fixed; inset: 0; background: #000; z-index: 300; display: none; align-items: center; justify-content: center; }
    .viewer.open { display: flex; }
    .viewer img { max-width: 100%; max-height: 90vh; }
    .v-close { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 30px; background: none; border: none; cursor: pointer; }
    .v-dl { position: absolute; bottom: 30px; background: var(--accent); color: #000; border: none; padding: 12px 30px; border-radius: 30px; font-weight: 700; cursor: pointer; }

    /* --- UTILS --- */
    .hidden { display: none !important; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .count-badge { background: var(--accent); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 700; margin-left: 5px; }

  </style>
</head>
<body>

<!-- SOUND EFFECT -->
<audio id="popSound" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>

<!-- HEADER -->
<header id="pageHeader">
    <div class="header-overlay">
        <img id="pageLogo" class="brand-logo" alt="Logo" onerror="this.style.display='none'">
        <div id="welcomeText" class="welcome-text"></div>
        <h1 class="brand-title" id="pageTitle">EventLens Gallery</h1>
    </div>
</header>

<!-- SEARCH SECTION -->
<div class="container" id="searchContainer">
    <div class="search-card">
        <i class="fa-solid fa-face-smile-wink search-icon"></i>
        <h3>Find Your Photos</h3>
        <p style="color:var(--muted); margin-bottom: 25px; line-height: 1.5;">Upload a selfie to instantly find all your photos from this event using AI.</p>
        
        <input type="file" id="selfieInput" accept="image/*" hidden onchange="handleSelfieSelect(this.files[0])">
        <button class="btn-main" onclick="document.getElementById('selfieInput').click()">
            <i class="fa-solid fa-camera"></i> Upload Selfie
        </button>

        <!-- Preview of uploaded selfie (Optional feedback) -->
        <div id="selfiePreviewContainer" class="hidden" style="margin-top: 15px;">
            <img id="selfiePreviewImg" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent);">
        </div>

        <div id="loader" class="hidden" style="margin-top: 25px;">
            <i class="fa-solid fa-circle-notch fa-spin" style="color:var(--accent); font-size: 24px;"></i>
            <p style="color:var(--muted); font-size: 14px; margin-top: 10px;" id="loaderText">Processing...</p>
        </div>
    </div>
</div>

<!-- GALLERY SECTION (Hidden Initially) -->
<div class="container hidden" id="galleryContainer">
    <div class="gallery-header">
        <h3 style="margin:0;">Results <span id="matchCount" class="count-badge">0</span></h3>
        <button id="btnToggleSelect" class="tag-pill" onclick="toggleSelectionMode()"><i class="fa-solid fa-check-double"></i> Select</button>
    </div>
    
    <div class="grid" id="galleryGrid" style="margin-top: 15px;"></div>
    
    <!-- PAGINATION -->
    <div id="loadMoreContainer" class="load-more-container hidden">
        <button class="btn-load" onclick="loadMorePhotos()">Load More <i class="fa-solid fa-chevron-down"></i></button>
    </div>
    
    <div style="text-align:center; padding: 40px; color: #555;" class="hidden" id="noResultsMsg">
        <i class="fa-regular fa-face-frown-open" style="font-size: 40px; margin-bottom: 10px;"></i>
        <p>No matches found. Try a clearer selfie.</p>
        <button class="btn-main" onclick="location.reload()" style="margin-top: 15px; font-size: 14px;">Try Again</button>
    </div>
</div>

<!-- STICKY ACTION BAR -->
<div class="action-bar" id="actionBar">
    <div style="color: var(--muted); font-size: 12px; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #111; padding: 4px 12px; border-radius: 12px; border: 1px solid #333;">
        <span id="selCount">0</span> Selected
    </div>
    <button class="act-btn" onclick="selectAllMatches()"><i class="fa-solid fa-check-square"></i> All</button>
    <button class="act-btn" onclick="downloadSelectedItems()"><i class="fa-solid fa-download"></i> Save</button>
    <button class="act-btn" onclick="downloadAsZip()"><i class="fa-solid fa-file-zipper"></i> Zip</button>
    <button class="act-btn" onclick="shareOnWhatsapp()"><i class="fa-brands fa-whatsapp"></i> Share</button>
</div>

<!-- LEAD MODAL (Intermediate Step) -->
<div class="modal" id="leadModal">
    <div class="modal-card">
        <div style="width: 60px; height: 60px; background: var(--accent-soft); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
            <i class="fa-solid fa-check" style="color: var(--accent); font-size: 24px;"></i>
        </div>
        <h2 style="margin: 0 0 10px;">Photos Found!</h2>
        <p style="color: var(--muted); margin-bottom: 25px;">We found <span id="leadMatchCount" style="color: #fff; font-weight: 700;">0</span> photos matching your selfie. Enter details to view them.</p>
        
        <input id="guestName" class="lead-input" placeholder="Your Name">
        <input id="guestMobile" class="lead-input" placeholder="Mobile Number" type="tel">
        
        <button class="btn-main" style="width: 100%; justify-content: center;" onclick="unlockGallery()">
            View Photos
        </button>
    </div>
</div>

<!-- VIEWER (Lightbox) -->
<div class="viewer" id="viewer">
    <button class="v-close" onclick="closeViewer()">&times;</button>
    <img id="viewerImg">
    <button class="v-dl" onclick="downloadSingle()">Download HD</button>
</div>

<script>
    /* --- CONFIG --- */
    const API_BASE = "https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod";
    const urlParams = new URLSearchParams(window.location.search);
    const linkId = urlParams.get('linkId');
    const cid = urlParams.get('cid'); 
    
    // Pagination Config
    const PAGE_SIZE = 50;
    let currentPage = 0;

    /* --- STATE --- */
    let allMatches = []; 
    let displayedMatches = [];
    let selectedIndices = new Set();
    let favorites = new Set(); // Local Storage Favorites
    let pendingSelfieBase64 = null;
    let isSelectMode = false;
    let currentViewUrl = null;

    /* --- INIT --- */
    window.onload = async () => {
        // Load Favorites
        const storedFavs = localStorage.getItem('el_favs_' + (linkId || cid));
        if(storedFavs) favorites = new Set(JSON.parse(storedFavs));

        // Branding Load
        let brandingApiUrl = "";
        if (linkId) brandingApiUrl = `${API_BASE}/get-branding?linkId=${linkId}`;
        else if (cid) brandingApiUrl = `${API_BASE}/get-branding?cid=${cid}`;
        
        if (brandingApiUrl) {
            try {
                const res = await fetch(brandingApiUrl);
                if(res.ok) applyBranding(await res.json());
            } catch(e) { console.error("Branding fetch failed", e); }
        }
    };

    /* --- BRANDING --- */
    function applyBranding(data) {
        if(data.collection_name) {
            document.getElementById('pageTitle').innerText = data.collection_name;
            document.title = `${data.collection_name} – Gallery`;
        }
        if(data.welcome_msg) {
            const el = document.getElementById('welcomeText');
            el.innerText = data.welcome_msg;
            el.style.display = 'block';
        }
        if(data.color) {
            document.documentElement.style.setProperty('--accent', data.color);
            document.documentElement.style.setProperty('--accent-soft', data.color + '26');
            document.getElementById('pageLogo').style.borderColor = data.color;
        }
        if(data.overlay_opacity) document.documentElement.style.setProperty('--overlay-op', data.overlay_opacity);
        
        if(data.header_img) {
            const img = new Image();
            img.onload = () => document.getElementById('pageHeader').style.backgroundImage = `url('${data.header_img}')`;
            img.src = data.header_img; 
        }
        if(data.logo) {
            const logo = document.getElementById('pageLogo');
            logo.src = data.logo;
            logo.style.display = 'block';
        }
        
        const style = document.createElement('style');
        style.innerHTML = `
            :root { --logo-size: ${data.logo_size_mob || '80'}px; --banner-height: ${data.banner_h_mob || '220'}px; }
            @media (min-width: 768px) { :root { --logo-size: ${data.logo_size_desk || '120'}px; --banner-height: ${data.banner_h_desk || '350'}px; } }
        `;
        document.head.appendChild(style);
    }

    /* --- STEP 1: SELFIE & SEARCH --- */
    function resizeImage(file, maxWidth = 800) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onerror = () => reject("Image load error.");
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.90));
                };
            };
            reader.onerror = error => reject(error);
        });
    }

    async function handleSelfieSelect(file) {
        if(!file) return;
        
        if (!linkId && !cid) {
            alert("Configuration Error: Missing linkId in URL.");
            return;
        }

        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        loader.classList.remove('hidden');
        loaderText.innerText = "Scanning your face...";
        
        try {
            pendingSelfieBase64 = await resizeImage(file, 800);
            document.getElementById('selfiePreviewImg').src = pendingSelfieBase64;
            document.getElementById('selfiePreviewContainer').classList.remove('hidden');

            loaderText.innerText = "Searching gallery...";
            const base64Clean = pendingSelfieBase64.split(',')[1];

            const res = await fetch(`${API_BASE}/search`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ linkId: linkId || cid, selfie_image: base64Clean })
            });
            
            if (!res.ok) throw new Error("Server error");
            const data = await res.json();
            loader.classList.add('hidden');

            if(data.matches && Array.isArray(data.matches) && data.matches.length > 0) {
                allMatches = data.matches;
                currentPage = 0; // Reset pagination
                document.getElementById('leadMatchCount').innerText = allMatches.length;
                document.getElementById('leadModal').classList.add('open');
                
                // Sound & Confetti
                document.getElementById('popSound').play().catch(()=>{});
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else {
                document.getElementById('noResultsMsg').classList.remove('hidden');
                alert("No matching photos found. Try a selfie with better lighting.");
            }
        } catch(e) {
            console.error("Search Error:", e);
            alert("Search failed. Please checking your internet.");
            loader.classList.add('hidden');
        }
    }

    /* --- STEP 2: LEAD CAPTURE & GALLERY --- */
    async function unlockGallery() {
        const name = document.getElementById('guestName').value;
        const mobile = document.getElementById('guestMobile').value;
        
        if(!name || !mobile) {
            alert("Please enter your Name and Mobile Number to verify.");
            return;
        }

        document.getElementById('leadModal').classList.remove('open');
        document.getElementById('searchContainer').classList.add('hidden'); 
        document.getElementById('galleryContainer').classList.remove('hidden');
        
        // Initial Render (First 50)
        renderBatch();
        
        try {
            const base64Clean = pendingSelfieBase64.split(',')[1];
            fetch(`${API_BASE}/save-details`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    mobile: mobile,
                    linkId: linkId, 
                    name: name, 
                    selfie_image: base64Clean, 
                    photo_count: allMatches.length,
                    collection_id: cid || linkId
                })
            });
        } catch(e) { console.error("Lead save error", e); }
    }

    /* --- STEP 3: PAGINATION & RENDER --- */
    function renderBatch() {
        const start = currentPage * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        const batch = allMatches.slice(start, end);
        const grid = document.getElementById('galleryGrid');
        
        if (start === 0 && batch.length === 0) {
            document.getElementById('noResultsMsg').classList.remove('hidden');
            return;
        }

        // Add Ribbon for new matches only if quality score is high (Optional logic)
        // Using "New" ribbon for first batch
        const isFirstBatch = (currentPage === 0);

        const html = batch.map((p, i) => {
            const globalIndex = start + i;
            // Use thumbnail_url if available (from smart backend), else use url
            const displayUrl = p.thumbnail_url || p.url;
            const isFav = favorites.has(p.photo_id) ? 'active' : '';
            const ribbon = (isFirstBatch && i < 3) ? '<div class="ribbon">TOP</div>' : '';

            return `
            <div class="photo-item" id="pitem-${globalIndex}" onclick="handleItemClick(${globalIndex})">
                ${ribbon}
                <img src="${displayUrl}" referrerpolicy="no-referrer" loading="lazy" alt="Photo ${globalIndex+1}" 
                     onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:100%;color:#666;font-size:10px;text-align:center;padding:5px;word-break:break-all;background:#222;\'><span>Not Found<br>${p.photo_id.substring(0,10)}...</span></div>'">
                <div class="select-ring"></div>
                <button class="fav-btn ${isFav}" onclick="toggleFav(event, '${p.photo_id}')">
                    <i class="${isFav ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
                </button>
            </div>
            `;
        }).join('');

        if (currentPage === 0) grid.innerHTML = html;
        else grid.insertAdjacentHTML('beforeend', html);

        displayedMatches = allMatches.slice(0, end);

        // Show/Hide Load More
        const loadBtn = document.getElementById('loadMoreContainer');
        if (end < allMatches.length) loadBtn.classList.remove('hidden');
        else loadBtn.classList.add('hidden');
    }

    function loadMorePhotos() {
        currentPage++;
        renderBatch();
    }

    /* --- FAVORITES --- */
   async function toggleFav(e, photoId) {
    e.stopPropagation();

    const btn = e.currentTarget;
    const icon = btn.querySelector('i');
    const isFav = favorites.has(photoId);

    if (isFav) {
        favorites.delete(photoId);
        btn.classList.remove('active');
        icon.classList.remove('fa-solid');
        icon.classList.add('fa-regular');
    } else {
        favorites.add(photoId);
        btn.classList.add('active');
        icon.classList.remove('fa-regular');
        icon.classList.add('fa-solid');

        // Small pulse animation
        btn.style.transform = "scale(1.3)";
        setTimeout(() => btn.style.transform = "scale(1)", 200);
    }

    // ✅ LOCAL SAVE (same as before)
    localStorage.setItem(
        'el_favs_' + (linkId || cid),
        JSON.stringify([...favorites])
    );

    // ✅ NEW: BACKEND SYNC (Dashboard ke liye)
    try {
        await fetch(`${API_BASE}/client-api`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: "update_selection",
                payload: {
                    collection_id: cid,
                    photo_id: photoId,
                    fav: !isFav
                }
            })
        });
    } catch (err) {
        console.error("Favourite sync failed", err);
    }
}


    /* --- SELECTION & VIEWER --- */
    function toggleSelectionMode() {
        isSelectMode = !isSelectMode;
        document.body.classList.toggle('select-mode', isSelectMode);
        
        const btn = document.getElementById('btnToggleSelect');
        if(isSelectMode) {
            btn.classList.add('active');
            btn.innerHTML = `<i class="fa-solid fa-times"></i> Cancel`;
        } else {
            btn.classList.remove('active');
            btn.innerHTML = `<i class="fa-solid fa-check-double"></i> Select`;
            selectedIndices.clear();
            updateActionBar();
            document.querySelectorAll('.photo-item.selected').forEach(el => el.classList.remove('selected'));
        }
    }

    function handleItemClick(index) {
        if(isSelectMode) {
            const el = document.getElementById(`pitem-${index}`);
            if(selectedIndices.has(index)) {
                selectedIndices.delete(index);
                el.classList.remove('selected');
            } else {
                selectedIndices.add(index);
                el.classList.add('selected');
            }
            updateActionBar();
        } else {
            const p = allMatches[index];
            // Always view full resolution url
            if(p.url) {
                currentViewUrl = p.url;
                document.getElementById('viewerImg').src = currentViewUrl;
                document.getElementById('viewer').classList.add('open');
            }
        }
    }

    function updateActionBar() {
        const bar = document.getElementById('actionBar');
        document.getElementById('selCount').innerText = selectedIndices.size;
        
        if(selectedIndices.size > 0) bar.classList.add('visible');
        else bar.classList.remove('visible');
    }

    function selectAllMatches() {
        // Select only currently loaded
        displayedMatches.forEach((_, i) => {
            selectedIndices.add(i);
            const el = document.getElementById(`pitem-${i}`);
            if(el) el.classList.add('selected');
        });
        updateActionBar();
    }

    /* --- DOWNLOAD & SHARE LOGIC --- */
    async function downloadSelectedItems() {
        if(selectedIndices.size === 0) return;
        const indices = Array.from(selectedIndices);
        
        const btn = document.querySelector('.act-btn .fa-download').parentElement;
        const originalText = btn.innerHTML;
        btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Saving...`;

        for(let i of indices) {
            const p = allMatches[i];
            if(p.url) {
                try {
                    // Direct Blob Download (No New Window)
                    const resp = await fetch(p.url);
                    const blob = await resp.blob();
                    saveAs(blob, `photo_${i+1}.jpg`);
                } catch(e) {
                    // Fallback
                    saveAs(p.url, `photo_${i+1}.jpg`);
                }
            }
            await new Promise(r => setTimeout(r, 500)); 
        }
        btn.innerHTML = originalText;
    }

    async function downloadAsZip() {
        if(selectedIndices.size === 0) return;
        const zip = new JSZip();
        const folder = zip.folder("EventLens_Photos");
        const btn = document.querySelector('.act-btn .fa-file-zipper').parentElement;
        const originalText = btn.innerHTML;
        btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Zipping...`;

        const indices = Array.from(selectedIndices);
        
        await Promise.all(indices.map(async (idx) => {
            try {
                const p = allMatches[idx];
                if(p.url) {
                    const blob = await fetch(p.url).then(r => r.blob());
                    folder.file(`photo_${idx+1}.jpg`, blob);
                }
            } catch(e) { console.error(e); }
        }));

        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, "My_Photos.zip");
        btn.innerHTML = originalText;
    }

    function shareOnWhatsapp() {
        const text = `Hey! Check out my photos from the event: ${window.location.href}`;
        // WhatsApp API link
        const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
        window.open(url, '_blank');
    }

    function downloadSingle() {
        if(currentViewUrl) {
            fetch(currentViewUrl)
                .then(resp => resp.blob())
                .then(blob => saveAs(blob, "photo.jpg"))
                .catch(() => saveAs(currentViewUrl, "photo.jpg"));
        }
    }
    
    function closeViewer() { document.getElementById('viewer').classList.remove('open'); }

</script>
